{% extends 'base_complete.html' %}

{% block title %}Chat - {{ task.title }} - ErrandExpress üöÄ{% endblock %}

{% block content %}
<style>
    @media (max-width: 1024px) {

        .chat-sidebar,
        .chat-task-sidebar {
            display: none;
        }

        .chat-layout {
            height: auto;
        }

        #chat-main-area {
            min-height: calc(100vh - 4rem);
        }
    }

    @media (max-width: 768px) {
        .chat-layout {
            flex-direction: column;
            height: auto;
        }

        #chat-main-area {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 4rem);
        }

        #messages-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        #message-input-container {
            position: relative;
            bottom: auto;
            left: auto;
            right: auto;
            padding: 1rem;
            border-top: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 -4px 12px rgba(15, 23, 42, 0.18);
            background: #ffffff;
            z-index: 40;
            flex-shrink: 0;
            width: 100%;
        }

        .message-input-row {
            align-items: center;
            gap: 0.75rem;
        }

        #message-input-container .btn-icon,
        #message-input-container .btn-primary {
            margin-bottom: 0;
            flex-shrink: 0;
        }

        #message-input-container .btn-icon {
            border-radius: 9999px;
        }

        #message-input {
            border-radius: 9999px;
            min-height: 48px;
            padding: 0.75rem 3rem 0.75rem 1.25rem;
            line-height: 1.4;
            width: 100%;
        }

        #send-button {
            height: 48px;
            border-radius: 9999px;
            padding: 0 1.5rem;
            flex-shrink: 0;
        }

        .message-help-tips {
            display: none;
        }

        #message-limit-notice,
        .message-instructions {
            margin-bottom: 0.75rem;
        }

        #paywall-overlay {
            position: absolute;
            inset: 0;
        }
    }

    @media (max-width: 480px) {
        #message-input-container {
            padding: 0.75rem;
        }

        #message-input {
            padding-right: 2.5rem;
        }

        #send-button span {
            display: none;
        }
    }
</style>
<div class="chat-layout h-[calc(100vh-4rem)] flex">
    <!-- Chat List Sidebar -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <!-- Header -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="font-poppins font-semibold text-lg">Messages</h2>
                <button class="btn-icon">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <!-- Search -->
            <div class="relative mt-3">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-4 h-4 text-muted"></i>
                </div>
                <input type="text"
                    class="w-full pl-10 pr-4 py-2 text-sm rounded-lg border border-gray-200 focus:border-primary focus:ring-1 focus:ring-primary/20 outline-none"
                    placeholder="Search conversations...">
            </div>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto">
            <div class="p-2 space-y-1">
                <!-- Active Chat -->
                <div class="flex items-center p-3 rounded-lg bg-primary/5 border-l-4 border-primary cursor-pointer">
                    <div class="relative mr-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-r from-primary to-indigo-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">{{ task.poster.fullname.0|upper }}</span>
                        </div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-mint rounded-full ring-2 ring-white"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="font-medium text-sm truncate">{{ task.title }}</p>
                            <span class="text-xs text-muted">2m</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-muted truncate">Great! I'll start working on it...</p>
                            <span
                                class="bg-primary text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                        </div>
                    </div>
                </div>

                <!-- Other Chats -->
                <div class="flex items-center p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <div class="relative mr-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-r from-mint to-green-400 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">M</span>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="font-medium text-sm truncate">Data Entry Project</p>
                            <span class="text-xs text-muted">1h</span>
                        </div>
                        <p class="text-sm text-muted truncate">Task completed successfully!</p>
                    </div>
                </div>

                <div class="flex items-center p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <div class="relative mr-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-r from-accent to-yellow-400 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">A</span>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="font-medium text-sm truncate">Logo Design Task</p>
                            <span class="text-xs text-muted">3h</span>
                        </div>
                        <p class="text-sm text-muted truncate">Can you provide more details?</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col" id="chat-main-area">
        <!-- Chat Header -->
        <div class="p-4 border-b border-gray-200 bg-white">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <div
                            class="w-10 h-10 bg-gradient-to-r from-primary to-indigo-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">{{ task.poster.fullname.0|upper }}</span>
                        </div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-mint rounded-full ring-2 ring-white"></span>
                    </div>
                    <div>
                        <h3 class="font-poppins font-semibold">{{ task.title }}</h3>
                        <p class="text-sm text-muted">{{ task.poster.fullname }} ‚Ä¢ Online</p>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <button class="btn-icon" title="Task Details">
                        <i data-lucide="info" class="w-4 h-4"></i>
                    </button>
                    <button class="btn-icon" title="More Options">
                        <i data-lucide="more-vertical" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Message Limit Notice -->
            {% if not task.chat_unlocked %}
            <div id="message-limit-notice"
                class="flex items-center justify-between p-3 bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-5 h-5 text-amber-600"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-900">üí¨ <span id="messages-remaining">5</span> Free
                            Messages</p>
                        <p class="text-xs text-gray-600">Unlock unlimited chat for ‚Ç±2 after preview</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="message-progress"
                            class="h-full bg-gradient-to-r from-green-500 to-amber-500 transition-all duration-300"
                            style="width: 100%"></div>
                    </div>
                    <span id="message-count" class="text-xs font-bold text-amber-600">0/5</span>
                </div>
            </div>

            <!-- Commission Payment Overlay (shown when commission not paid) -->
            <div id="commission-paywall-overlay"
                class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-30 flex items-center justify-center">
                <div class="text-center p-8 max-w-md">
                    <div
                        class="w-20 h-20 bg-gradient-to-r from-amber-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="credit-card" class="w-10 h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">üí≥ Commission Payment Required</h3>
                    <p class="text-gray-600 mb-4">
                        To continue chatting, please pay the <strong class="text-amber-600">‚Ç±10.00 commission fee</strong>.<br>
                        This is a one-time payment for this task.
                    </p>

                    <!-- Benefits -->
                    <div class="bg-amber-50 rounded-xl p-4 mb-6 text-left">
                        <p class="text-sm font-semibold text-gray-900 mb-2">‚ú® What you get:</p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                Unlock unlimited messaging
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                File sharing & attachments
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                Real-time collaboration
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                One-time payment per task
                            </li>
                        </ul>
                    </div>

                    <button onclick="payCommission()"
                        class="w-full px-6 py-4 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-xl hover:shadow-lg transition-all font-semibold text-lg flex items-center justify-center gap-2">
                        <i data-lucide="credit-card" class="w-5 h-5"></i>
                        <span>Pay Commission - ‚Ç±10.00</span>
                    </button>

                    <p class="text-xs text-gray-500 mt-3">
                        üí≥ Pay via GCash or Cash on Delivery
                    </p>
                </div>
            </div>

            {% endif %}
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="messages-container">
            <!-- System Message -->
            <div class="flex justify-center mb-4">
                <div class="bg-white px-4 py-2 rounded-full shadow-sm border">
                    <p class="text-xs text-muted">Chat started ‚Ä¢ {{ task.created_at|date:"M d, Y" }}</p>
                </div>
            </div>

            <!-- Messages -->
            <div class="space-y-4" id="messages-list">
                {% for message in messages %}
                <div class="flex {% if message.sender == user %}justify-end{% else %}justify-start{% endif %}"
                    data-message-id="{{ message.id }}">
                    <div class="max-w-xs lg:max-w-md">
                        <div
                            class="{% if message.sender == user %}chat-bubble-poster{% else %}chat-bubble-doer{% endif %}">
                            <p class="text-sm">{{ message.message }}</p>

                            {% if message.attachment %}
                            <!-- Attachment -->
                            <div class="mt-2 p-3 bg-white/20 rounded-lg border border-white/30">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="file-text" class="w-4 h-4 text-white"></i>
                                    <a href="{{ message.attachment.url }}" target="_blank"
                                        class="text-sm text-white hover:underline flex-1 truncate">
                                        {{ message.attachment.name|default:"attachment" }}
                                    </a>
                                    <a href="{{ message.attachment.url }}" download
                                        class="ml-auto text-white/80 hover:text-white">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <p class="text-xs text-muted {% if message.sender == user %}text-right{% endif %} mt-1">
                            {{ message.created_at|date:"g:i A" }}
                        </p>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-8">
                    <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No messages yet. Start the conversation!</p>
                </div>
                {% endfor %}

                <!-- Typing Indicator -->
                <div class="flex justify-start" id="typing-indicator" style="display: none;">
                    <div class="max-w-xs lg:max-w-md">
                        <div class="chat-bubble-doer">
                            <div class="flex items-center space-x-1">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                                        style="animation-delay: 0.1s;"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                                        style="animation-delay: 0.2s;"></div>
                                </div>
                                <span class="text-xs text-gray-500 ml-2">typing...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Input -->
        <div class="p-4 border-t border-gray-200 bg-white relative" id="message-input-container">
            {% if task.chat_unlocked %}
            <!-- Instructions for unlocked chat -->
            <div class="mb-3 p-3 bg-green-50 border-l-4 border-green-500 rounded-lg flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                <div>
                    <p class="text-sm font-semibold text-green-900">‚úÖ Chat Unlocked - Unlimited Messaging</p>
                    <p class="text-xs text-green-700">Send messages, share files, and collaborate freely!</p>
                </div>
            </div>

            <div class="flex items-end space-x-3">
                <!-- Attachment Button -->
                <button class="btn-icon mb-2" title="Attach File">
                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                </button>

                <!-- Message Input -->
                <div class="flex-1 relative">
                    <textarea id="message-input"
                        class="w-full p-3 pr-12 rounded-2xl border-2 border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none max-h-32"
                        placeholder="Type your message here... (Press Enter to send)" rows="1"></textarea>

                    <!-- Emoji Button -->
                    <button class="absolute right-3 top-3 btn-icon p-1" title="Add Emoji">
                        <i data-lucide="smile" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Send Button -->
                <button id="send-button" class="btn-primary mb-2 px-4 py-3" onclick="sendMessage()">
                    <i data-lucide="send" class="w-4 h-4 mr-1"></i>
                    <span class="hidden sm:inline">Send</span>
                </button>
            </div>

            <!-- Helpful Tips -->
            <div class="mt-3 flex items-center gap-4 text-xs text-gray-500">
                <span class="flex items-center gap-1">
                    <i data-lucide="info" class="w-3 h-3"></i>
                    Press Enter to send
                </span>
                <span class="flex items-center gap-1">
                    <i data-lucide="paperclip" class="w-3 h-3"></i>
                    Attach files
                </span>
                <span class="flex items-center gap-1">
                    <i data-lucide="smile" class="w-3 h-3"></i>
                    Add emoji
                </span>
            </div>
            {% else %}
            <!-- Free Message Preview Mode -->
            <div class="mb-3 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-lg flex items-center gap-3">
                <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
                <div>
                    <p class="text-sm font-semibold text-blue-900">üìù Preview Mode - Limited Messaging</p>
                    <p class="text-xs text-blue-700">Send up to 5 messages to discuss the task. Unlock for unlimited
                        chat!</p>
                </div>
            </div>

            <div class="flex items-end space-x-3" id="message-input-area">
                <!-- Message Input -->
                <div class="flex-1 relative">
                    <textarea id="message-input"
                        class="w-full p-3 pr-12 rounded-2xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none resize-none max-h-32"
                        placeholder="Type your message... (You have 5 free messages)" rows="1"></textarea>

                    <!-- Character Counter -->
                    <div class="absolute right-3 bottom-3 text-xs text-gray-400">
                        <span id="char-count">0</span>/500
                    </div>
                </div>

                <!-- Send Button -->
                <button id="send-button" class="btn-primary mb-2 px-4 py-3" onclick="sendMessage()">
                    <i data-lucide="send" class="w-4 h-4 mr-1"></i>
                    <span class="hidden sm:inline">Send</span>
                </button>
            </div>

            <!-- Warning at 4th message - Professional Alert -->
            <div id="last-message-warning"
                class="hidden mt-3 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-500 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 pt-0.5">
                        <div class="flex items-center justify-center h-8 w-8 rounded-full bg-amber-100">
                            <i data-lucide="zap" class="w-5 h-5 text-amber-600"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-bold text-amber-900">Last Free Message</p>
                        <p class="text-xs text-amber-700 mt-1">You have <span class="font-semibold">1 message remaining</span> before chat unlock is required.</p>
                        <div class="mt-2 flex items-center gap-2">
                            <span class="inline-block px-2.5 py-1 bg-amber-100 text-amber-800 text-xs font-semibold rounded-full">
                                üí≥ Unlock for ‚Ç±2
                            </span>
                            <span class="text-xs text-amber-600">One-time payment per task</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paywall Overlay (shown after 5 messages) -->
            <div id="paywall-overlay"
                class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-20 flex items-center justify-center">
                <div class="text-center p-8 max-w-md">
                    <div
                        class="w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="lock" class="w-10 h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">üîí Message Limit Reached</h3>
                    <p class="text-gray-600 mb-4">
                        You've used your <strong>5 free messages</strong>.<br>
                        Unlock unlimited messaging for just <strong class="text-blue-600">‚Ç±2</strong>!
                    </p>

                    <!-- Benefits -->
                    <div class="bg-blue-50 rounded-xl p-4 mb-6 text-left">
                        <p class="text-sm font-semibold text-gray-900 mb-2">‚ú® Unlock Benefits:</p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                Unlimited messages
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                File sharing & attachments
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                Real-time collaboration
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                                One-time payment per task
                            </li>
                        </ul>
                    </div>

                    <button onclick="unlockChat()"
                        class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:shadow-lg transition-all font-semibold text-lg flex items-center justify-center gap-2">
                        <i data-lucide="unlock" class="w-5 h-5"></i>
                        <span>Unlock Chat - ‚Ç±2</span>
                    </button>

                    <p class="text-xs text-gray-500 mt-3">
                        üí≥ Pay via GCash or Cash on Delivery
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Task Details Sidebar -->
    <div class="w-80 bg-white border-l border-gray-200 flex flex-col">
        <!-- Task Info -->
        <div class="p-4 border-b border-gray-200">
            <h3 class="font-poppins font-semibold text-lg mb-3">Task Details</h3>

            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-muted">Status</span>
                    <span class="badge badge-accent">{{ task.status|title }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-muted">Price</span>
                    <span class="font-semibold">‚Ç±{{ task.price }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-muted">Payment</span>
                    <span
                        class="badge {% if task.payment_method == 'gcash' %}badge-mint{% else %}badge-accent{% endif %}">
                        {{ task.payment_method|upper }}
                    </span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-muted">Deadline</span>
                    <span class="text-sm font-medium">{{ task.deadline|date:"M d" }}</span>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="p-4 border-b border-gray-200">
            <h4 class="font-poppins font-semibold mb-3">Progress</h4>
            <div class="space-y-2">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-muted">Completion</span>
                    <span class="font-medium">60%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-primary h-2 rounded-full" style="width: 60%"></div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="p-4 border-b border-gray-200">
            <h4 class="font-poppins font-semibold mb-3">Quick Actions</h4>
            <div class="space-y-2">
                <button class="btn-ghost w-full text-sm">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    View Full Task
                </button>
                <button class="btn-ghost w-full text-sm">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Submit Work
                </button>
                <button class="btn-ghost w-full text-sm">
                    <i data-lucide="flag" class="w-4 h-4"></i>
                    Report Issue
                </button>
            </div>
        </div>

        <!-- Shared Files -->
        <div class="p-4 flex-1">
            <h4 class="font-poppins font-semibold mb-3">Shared Files</h4>
            <div class="space-y-2">
                <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50">
                    <i data-lucide="file-text" class="w-4 h-4 text-muted"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">requirements.pdf</p>
                        <p class="text-xs text-muted">2.3 MB</p>
                    </div>
                    <button class="btn-icon p-1">
                        <i data-lucide="download" class="w-3 h-3"></i>
                    </button>
                </div>

                <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50">
                    <i data-lucide="image" class="w-4 h-4 text-muted"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">sample-design.png</p>
                        <p class="text-xs text-muted">1.8 MB</p>
                    </div>
                    <button class="btn-icon p-1">
                        <i data-lucide="download" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% csrf_token %}
<script>
    let currentUser = '{{ user.id }}';
    let taskId = '{{ task.id }}';
    let typingTimeout;
    let isTyping = false;

    // 5-Message Limit System
    const chatUnlocked = {{ task.chat_unlocked| lower }};
    let messageCount = {{ message_count }}; // Loaded from backend
    const MAX_FREE_MESSAGES = 5;

    // Get CSRF token from cookie or DOM
    function getCSRFToken() {
        // Try to get from DOM first
        const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (tokenInput) {
            return tokenInput.value;
        }

        // Fallback to cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }

    // Initialize message counter
    function initMessageCounter() {
        updateMessageCounter();
    }

    // Update message counter display
    function updateMessageCounter() {
        if (chatUnlocked) return; // No limit if chat is unlocked

        const remaining = MAX_FREE_MESSAGES - messageCount;
        const messagesRemainingEl = document.getElementById('messages-remaining');
        const messageCountEl = document.getElementById('message-count');
        const messageProgressEl = document.getElementById('message-progress');
        const lastMessageWarning = document.getElementById('last-message-warning');
        const paywallOverlay = document.getElementById('paywall-overlay');

        // Update counter text
        if (messagesRemainingEl) {
            messagesRemainingEl.textContent = Math.max(0, remaining);
        }
        if (messageCountEl) {
            messageCountEl.textContent = `${messageCount}/${MAX_FREE_MESSAGES}`;
        }

        // Update progress bar
        if (messageProgressEl) {
            const percentage = {{MAX_FREE_MESSAGES - messageCount) / MAX_FREE_MESSAGES) * 100; messageProgressEl.style.width = `${Math.max(0, percentage)}%`; // Change color based on remaining messages if (remaining <= 1) { messageProgressEl.className = 'h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-300'; } else if (remaining <= 2) { messageProgressEl.className = 'h-full bg-gradient-to-r from-amber-500 to-yellow-500 transition-all duration-300'; } } // Show warning at 4th message (1 remaining) if (remaining === 1 && lastMessageWarning) { lastMessageWarning.classList.remove('hidden'); } else if (lastMessageWarning) { lastMessageWarning.classList.add('hidden'); } // Show paywall at 5th message (0 remaining) if (remaining <= 0 && paywallOverlay) { paywallOverlay.classList.remove('hidden'); // Disable input const messageInput = document.getElementById('message-input'); const sendButton = document.getElementById('send-button'); if (messageInput) messageInput.disabled = true; if (sendButton) sendButton.disabled = true; } } // Check if user can send message function canSendMessage() { if (chatUnlocked) return true; return messageCount < MAX_FREE_MESSAGES; } // Unlock chat function function unlockChat() { // Redirect to payment page window.location.href = `/payment/system-fee/${taskId}/`; } // Commission payment function function payCommission() { // Redirect to commission payment page window.location.href = `/payment/commission/${taskId}/`; } // Show commission paywall when needed function showCommissionPaywall() { const commissionOverlay = document.getElementById('commission-paywall-overlay'); if (commissionOverlay) { commissionOverlay.classList.remove('hidden'); // Disable input const messageInput = document.getElementById('message-input'); const sendButton = document.getElementById('send-button'); if (messageInput) messageInput.disabled = true; if (sendButton) sendButton.disabled = true; } } // Character counter for textarea const messageInput = document.getElementById('message-input'); const charCount = document.getElementById('char-count'); if (messageInput && charCount) { messageInput.addEventListener('input', function () { charCount.textContent = this.value.length; if (this.value.length > 500) { charCount.classList.add('text-red-600'); } else { charCount.classList.remove('text-red-600'); } }); } // Initialize on page load document.addEventListener('DOMContentLoaded', function () { initMessageCounter(); // Reinitialize Lucide icons for this page (global handler in base template handles initial load) if (typeof lucide !== 'undefined' && lucide.createIcons) { lucide.createIcons(); } }); // Global handler for commission payment errors window.addEventListener('DOMContentLoaded', function() { // Check if there's a commission error in messages const djangoMessages = document.querySelectorAll('.django-message'); djangoMessages.forEach(msg => { const messageText = msg.getAttribute('data-message'); if (messageText && (messageText.includes('‚Ç±10') || messageText.includes('commission'))) {
                // Show commission overlay
                showCommissionPaywall();
            }
        });
    });

    // Override showToast to detect commission errors
    const originalShowToast = window.showToast;
    if (originalShowToast) {
        window.showToast = function(message, type) {
            if (message && (message.includes('‚Ç±10') || message.includes('commission'))) {
                showCommissionPaywall();
            } else {
                originalShowToast(message, type);
            }
        };
    }



    // Typing indicator functionality
    const typingIndicator = document.getElementById('typing-indicator');
    const messageInput = document.getElementById('message-input');

    // Show typing indicator
    function showTypingIndicator(userName) {
        if (typingIndicator) {
            document.getElementById('typing-user-name').textContent = `${userName} is typing...`;
            typingIndicator.classList.remove('hidden');
        }
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        if (typingIndicator) {
            typingIndicator.classList.add('hidden');
        }
    }

    // Send typing status to server (simulated with localStorage for demo)
    function sendTypingStatus(typing) {
        if (typing !== isTyping) {
            isTyping = typing;
            // In production, send to server via WebSocket or API
            localStorage.setItem(`typing_${taskId}_${currentUser}`, typing ? 'true' : 'false');
        }
    }

    // Check for other user typing (simulated)
    let lastTypingState = null;
    function checkOtherUserTyping() {
        const otherUserId = '{{ other_user.id }}';
        const otherUserName = '{{ other_user.fullname }}';
        const otherUserTyping = localStorage.getItem(`typing_${taskId}_${otherUserId}`);

        // Only update if state changed (prevent unnecessary DOM updates)
        if (otherUserTyping === 'true' && lastTypingState !== 'typing') {
            showTypingIndicator(otherUserName);
            lastTypingState = 'typing';
        } else if (otherUserTyping !== 'true' && lastTypingState !== 'idle') {
            hideTypingIndicator();
            lastTypingState = 'idle';
        }
    }

    // Auto-resize textarea and handle typing indicator
    messageInput?.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 128) + 'px';

        // Send typing indicator
        if (this.value.trim(}
            sendTypingStatus(true);

            // Clear previous timeout
            clearTimeout(typingTimeout);

            // Set timeout to stop typing indicator after 2 seconds of inactivity
            typingTimeout = setTimeout(() => { sendTypingStatus(false); }, 2000); } else { sendTypingStatus(false); } }); // Check for typing status every 2 seconds (instead of 500ms) // This reduces CPU usage and browser tab activity setInterval(checkOtherUserTyping, 2000); // Send message on Enter (but not Shift+Enter) document.getElementById('message-input')?.addEventListener('keydown', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); // Send message function function sendMessage() { const input = document.getElementById('message-input'); const message = input.value.trim(); if (!message) return; // Check message limit BEFORE doing anything if (!canSendMessage(}
            showToast('Message limit reached. Please pay ‚Ç±2 system fee to continue chatting.', 'warning');
            // Show payment modal
            const paywallOverlay = document.getElementById('paywall-overlay');
            if (paywallOverlay) {
                paywallOverlay.classList.remove('hidden');
            }
            return;
        }

        // Disable send button to prevent duplicate submissions
        const sendBtn = document.querySelector('button[onclick="sendMessage()"]');
        if (sendBtn) sendBtn.disabled = true;

        // Increment message count
        messageCount++;
        updateMessageCounter();

        // Add message to chat immediately (optimistic update)
        addMessageToChat(message, true);
        input.value = '';
        input.style.height = 'auto';

        // Re-enable send button immediately (message already shown to user)
        if (sendBtn) sendBtn.disabled = false;

        // Send to server (non-blocking, fire and forget)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout fetch(`/api/send-message/`, { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json', }, body: JSON.stringify({ task_id: taskId, message: message }), signal: controller.signal }).then(response => response.json()
            .then(data => {
                clearTimeout(timeoutId);
                if (!data.success) {
                    // If payment required, show paywall
                    if (data.payment_required) {
                        const paywallOverlay = document.getElementById('paywall-overlay');
                        if (paywallOverlay) {
                            paywallOverlay.classList.remove('hidden');
                        }
                    }
                    showToast(data.error || 'Failed to send message', 'error');
                    // Remove the optimistically added message
                    removeLastMessage();
                    messageCount--;
                    updateMessageCounter();
                }
            }).catch(error => {
                clearTimeout(timeoutId);
                // Only show error if not a timeout/abort
                if (error.name !== 'AbortError') {
                    showToast('Failed to send message', 'error');
                    removeLastMessage();
                    messageCount--;
                    updateMessageCounter();
                }
            });
    }

    // Add message to chat UI
    function addMessageToChat(message, isCurrentUser = false, timestamp = null) {
        const container = document.getElementById('messages-container');
        const messagesDiv = document.getElementById('messages-list');

        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

        const timeString = timestamp
            ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md">
                <div class="${isCurrentUser ? 'chat-bubble-poster' : 'chat-bubble-doer'}">
                    <p class="text-sm">${escapeHtml(message)}</p>
                </div>
                <p class="text-xs text-muted ${isCurrentUser ? 'text-right' : ''} mt-1">${timeString}</p>
            </div>
        `;

        messagesDiv.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    // HTML escaping helper
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Remove last message (for failed sends)
    function removeLastMessage() {
        const container = document.getElementById('messages-container');
        const messagesDiv = container.querySelector('.space-y-4');
        const lastMessage = messagesDiv.lastElementChild;
        if (lastMessage) {
            lastMessage.remove();
        }
    }

    // Show typing indicator
    function showTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'flex';
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'none';
    }

    // Pay system fee
    async function paySystemFee(taskId) {
        try {
            showLoading();
            const response = await fetch('/api/create-payment-intent/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId })
            });

            const data = await response.json();
            hideLoading();

            if (data.success) {
                window.open(data.checkout_url, '_blank');
                showToast('Redirecting to payment...', 'info');
            } else {
                showToast(data.error || 'Failed to create payment', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast('An error occurred. Please try again.', 'error');
        }
    }

    // Initialize chat
    document.addEventListener('DOMContentLoaded', function () {
        // Scroll to bottom
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;

        // Focus message input if chat is unlocked
        {% if task.chat_unlocked %}
        document.getElementById('message-input')?.focus();
        {% endif %}

        // Check for chat unlock status periodically
        {% if not task.chat_unlocked %}
        setInterval(async () => {
            try {
                const response = await fetch(`/api/check-chat/{{ task.id }}/`);
                const data = await response.json();

                if (data.allowed) {
                    showToast('Chat has been unlocked! üí¨', 'success');
                    setTimeout(() => location.reload(), 2000); } } catch (error) { console.error('Failed to check chat status:', error); } }, 5000); {% endif %} // Poll for new messages with optimized interval let isPolling = false; let lastMessageId = null; let pollController = null; async function loadNewMessages() { // Skip if already polling if (isPolling) return; // Cancel previous request if still pending if (pollController) { pollController.abort(); } isPolling = true; pollController = new AbortController(); try { const response = await fetch(`/api/messages/${taskId}/`, { signal: pollController.signal }); const data = await response.json(); if (data.success && data.messages && data.messages.length > 0) { const messagesList = document.getElementById('messages-list'); const existingIds = new Set( Array.from(messagesList.querySelectorAll('[data-message-id]'}}
                            .map(el => el.getAttribute('data-message-id'}}
                    );

                    // Add only new messages
                    let newMessagesCount = 0;
                    data.messages.forEach(msg => {
                        if (!existingIds.has(msg.id)) {
                            addMessageToChat(msg.message, msg.sender_id === currentUser, msg.created_at);
                            messageCount++;
                            newMessagesCount++;
                            lastMessageId = msg.id;
                        }
                    });

                    // Only update counter if new messages were added
                    if (newMessagesCount > 0) {
                        updateMessageCounter();
                    }
                }
            } catch (error) {
                // Ignore abort errors (expected when cancelling)
                if (error.name !== 'AbortError') {
                    console.error('Failed to load messages:', error);
                }
            } finally {
                isPolling = false;
                pollController = null;
            }
        }

        // Start polling with optimized interval (5 seconds instead of 3)
        // This reduces server load while still providing near-real-time updates
        setInterval(loadNewMessages, 5000);
    });
</script>
{% endblock %}