{% extends 'base_complete.html' %}
{% load static %}

{% block title %}Notifications - ErrandExpress{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 pb-20 relative overflow-hidden">

    <!-- Decorative Elements -->
    <div
        class="absolute top-0 right-0 w-96 h-96 bg-blue-400/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
    </div>
    <div
        class="absolute bottom-0 left-0 w-96 h-96 bg-indigo-400/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2 pointer-events-none">
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 relative z-10">

        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8 group">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight mb-2">Notifications</h1>
                <p class="text-slate-500 font-medium">Stay updated with your latest activities</p>
            </div>

            <button onclick="markAllAsRead()"
                class="relative inline-flex items-center px-5 py-2.5 rounded-xl bg-white/80 hover:bg-white text-indigo-600 font-semibold shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-300 border border-indigo-100/50 backdrop-blur-sm group-hover:border-indigo-200">
                <i data-lucide="check-check" class="w-4 h-4 mr-2 text-indigo-500"></i>
                Mark all as read
            </button>
        </div>

        <!-- Glass Panel -->
        <div
            class="bg-white/60 backdrop-blur-xl border border-white/50 rounded-3xl shadow-xl shadow-slate-200/40 overflow-hidden">

            <!-- Filters Toolbar -->
            <div class="px-6 pt-6 pb-2 border-b border-indigo-50/50">
                <div class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide no-scrollbar mask-linear-fade">
                    <button class="filter-tab active" data-filter="all">
                        <span class="icon-box"><i data-lucide="inbox"></i></span> All
                    </button>
                    <button class="filter-tab" data-filter="tasks">
                        <span class="icon-box"><i data-lucide="briefcase"></i></span> Tasks
                    </button>
                    <button class="filter-tab" data-filter="payments">
                        <span class="icon-box"><i data-lucide="dollar-sign"></i></span> Payments
                    </button>
                    <button class="filter-tab" data-filter="ratings">
                        <span class="icon-box"><i data-lucide="star"></i></span> Ratings
                    </button>
                    <button class="filter-tab" data-filter="skills">
                        <span class="icon-box"><i data-lucide="award"></i></span> Skills
                    </button>
                    <button class="filter-tab" data-filter="system">
                        <span class="icon-box"><i data-lucide="info"></i></span> System
                    </button>
                </div>
            </div>

            <!-- Notifications List -->
            <div class="p-6 min-h-[500px] bg-white/40">
                {% if notifications %}
                <div class="space-y-4" id="notifications-list">
                    {% for notification in notifications %}

                    <!-- Notification Card -->
                    <div class="relative group notification-card {% if not notification.is_read %}unread{% endif %}"
                        data-type="{{ notification.type }}">
                        <div
                            class="absolute inset-0 bg-white rounded-2xl shadow-sm border border-indigo-50/50 transition-all duration-300 group-hover:shadow-lg group-hover:border-indigo-200/50 group-hover:-translate-y-1">
                        </div>

                        <!-- Unread Glow -->
                        {% if not notification.is_read %}
                        <div
                            class="absolute inset-y-0 left-0 w-1.5 bg-gradient-to-b from-indigo-500 to-blue-600 rounded-l-2xl">
                        </div>
                        {% endif %}

                        <div class="relative p-5 pl-7 flex items-start gap-5">
                            <!-- Dynamic Icon -->
                            <div class="flex-shrink-0">
                                {% if notification.type == 'task_assigned' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="clipboard-check" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'task_completed' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="check-circle" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'payment_received' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-green-100 text-green-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'rating_received' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-yellow-100 text-yellow-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'skill_verified' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="award" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'system_message' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="info" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'deadline_reminder' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="clock" class="w-6 h-6"></i>
                                </div>
                                {% elif notification.type == 'task_overdue' %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-red-100 text-red-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                                </div>
                                {% else %}
                                <div
                                    class="w-12 h-12 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center shadow-inner ring-4 ring-white">
                                    <i data-lucide="bell" class="w-6 h-6"></i>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Content -->
                            <div class="flex-1 min-w-0 pt-1">
                                <div class="flex items-start justify-between gap-4">
                                    <div>
                                        <h4
                                            class="text-lg font-bold text-slate-900 group-hover:text-indigo-700 transition-colors mb-1">
                                            {{ notification.title }}
                                        </h4>
                                        <p class="text-slate-600 text-sm leading-relaxed mb-3">
                                            {{ notification.message }}
                                        </p>
                                    </div>
                                    <span
                                        class="text-xs font-semibold text-slate-400 whitespace-nowrap bg-slate-100 px-2 py-1 rounded-lg">
                                        {{ notification.created_at|timesince }} ago
                                    </span>
                                </div>

                                <!-- Action Button (Conditional) -->
                                {% if notification.related_task %}
                                <a href="{% url 'task_detail' notification.related_task.id %}"
                                    class="inline-flex items-center text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors group/link mt-1">
                                    View Task Details
                                    <i data-lucide="arrow-right"
                                        class="w-4 h-4 ml-1 transition-transform group-hover/link:translate-x-1"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if notifications.has_other_pages %}

                <div class="mt-10 flex justify-center pb-4">
                    <nav class="inline-flex rounded-xl shadow-sm bg-white p-1 gap-1 border border-indigo-50">
                        {% if notifications.has_previous %}
                        <a href="?page=1"
                            class="px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">First</a>
                        <a href="?page={{ notifications.previous_page_number }}"
                            class="px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">Prev</a>
                        {% endif %}

                        <span class="px-4 py-2 rounded-lg text-sm font-bold text-indigo-600 bg-indigo-50">
                            Page {{ notifications.number }}
                        </span>

                        {% if notifications.has_next %}
                        <a href="?page={{ notifications.next_page_number }}"
                            class="px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">Next</a>
                        <a href="?page={{ notifications.paginator.num_pages }}"
                            class="px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">Last</a>
                        {% endif %}
                    </nav>
                </div>
                {% endif %}

                {% else %}
                <!-- Empty State -->
                <div class="flex flex-col items-center justify-center py-20 text-center">
                    <div
                        class="w-24 h-24 bg-gradient-to-tr from-slate-100 to-indigo-50 rounded-full flex items-center justify-center mb-6 shadow-md border border-white">
                        <i data-lucide="bell-off" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">All Caught Up!</h3>
                    <p class="text-slate-500 max-w-sm mx-auto mb-8">You have no new notifications at the moment. Check
                        back later for updates.</p>
                    <a href="{% url 'dashboard' %}"
                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:shadow-xl hover:-translate-y-0.5 transition-all">
                        Return to Dashboard
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar Hide */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Filter Tabs Styling */
    .filter-tab {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
        background: transparent;
        border: 1px solid transparent;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
    }

    .filter-tab .icon-box {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        background: rgba(241, 245, 249, 0.5);
        color: #94a3b8;
        transition: all 0.2s;
    }

    .filter-tab .icon-box i {
        width: 0.875rem;
        height: 0.875rem;
    }

    .filter-tab:hover {
        color: #334155;
        background: #f8fafc;
    }

    .filter-tab:hover .icon-box {
        color: #64748b;
        background: #e2e8f0;
    }

    .filter-tab.active {
        background: #eff6ff;
        color: #2563eb;
        box-shadow: 0 1px 2px rgba(37, 99, 235, 0.05);
        border-color: #dbeafe;
    }

    .filter-tab.active .icon-box {
        background: white;
        color: #2563eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Safe icon initialization
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }

        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {

                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        window.markAllAsRead = function () {
            const csrftoken = getCookie('csrftoken');

            fetch('/api/notifications/mark-as-read/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove visual unread indicators
                        document.querySelectorAll('.notification-card.unread').forEach(card => {
                            card.classList.remove('unread');
                            const glowBar = card.querySelector('.bg-gradient-to-b');
                            if (glowBar) glowBar.remove();
                        });

                        // Update Badges
                        const desktopDot = document.getElementById('desktop-notification-dot');
                        const mobileBadge = document.getElementById('mobile-notification-badge');
                        const sidebarBadge = document.getElementById('sidebar-notification-badge');

                        if (desktopDot) desktopDot.style.display = 'none';

                        if (mobileBadge) {
                            mobileBadge.textContent = '0';
                            mobileBadge.style.display = 'none';
                        }

                        if (sidebarBadge) {
                            sidebarBadge.textContent = '0';
                            sidebarBadge.style.display = 'none';
                        }

                        // Show success message
                        if (typeof showNotification !== 'undefined') {
                            showNotification('All notifications marked as read', 'success');
                        }
                    } else {
                        // Show error message
                        if (typeof showNotification !== 'undefined') {
                            showNotification(data.error || 'Failed to mark notifications as read', 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof showNotification !== 'undefined') {
                        showNotification('An error occurred. Please try again.', 'error');
                    }
                });
        };

        // Filter Logic
        const filterTabs = document.querySelectorAll('.filter-tab');
        const notificationCards = document.querySelectorAll('.notification-card');

        console.log('Found filter tabs:', filterTabs.length); // Debug

        filterTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Active State
                filterTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const filter = tab.dataset.filter;
                console.log('Filter selected:', filter);

                notificationCards.forEach(card => {
                    const type = (card.dataset.type || '').trim();
                    let shouldShow = false;

                    // Robust matching logic
                    if (filter === 'all') {
                        shouldShow = true;
                    } else if (filter === 'tasks') {
                        if (['task_assigned', 'task_completed', 'report_filed'].includes(type) || type.includes('task')) shouldShow = true;
                    } else if (filter === 'payments') {
                        if (['payment_received'].includes(type) || type.includes('payment')) shouldShow = true;
                    } else if (filter === 'ratings') {
                        if (['rating_received'].includes(type) || type.includes('rating')) shouldShow = true;
                    } else if (filter === 'skills') {
                        if (['skill_verified'].includes(type) || type.includes('skill')) shouldShow = true;
                    } else if (filter === 'system') {
                        if (['system_message'].includes(type) || type.includes('system')) shouldShow = true;
                    }

                    if (shouldShow) {
                        card.style.display = 'block';
                        card.animate([
                            { opacity: 0, transform: 'translateY(10px)' },
                            { opacity: 1, transform: 'translateY(0)' }
                        ], { duration: 300, easing: 'ease-out' });
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
    });
</script>
{% endblock %}