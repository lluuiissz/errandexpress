<!DOCTYPE html>
<html lang="en" class="scroll-smooth" id="html-root">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ErrandExpress ðŸš€ - Smart Errands. Trusted Students.{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš€</text></svg>">

    <!-- Tailwind CSS with Fallback -->
    <script src="https://cdn.tailwindcss.com" onerror="loadTailwindFallback()"></script>
    <script>
        // Fallback for Tailwind CSS if CDN fails
        function loadTailwindFallback() {
            console.warn('Primary Tailwind CDN failed, loading fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/tailwindcss@3.3.5/dist/tailwind.min.js';
            script.onerror = function () {
                console.error('Tailwind CSS failed to load. Using basic styles.');
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd.js"></script>
    <script>
        // Initialize Lucide icons when library loads
        function initLucideIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            } else {
                // Retry if not loaded yet
                setTimeout(initLucideIcons, 100);
            }
        }

        // Initialize on script load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLucideIcons);
        } else {
            initLucideIcons();
        }
    </script>

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Custom Tailwind Configuration -->
    <script>
        // Wait for Tailwind to load before configuring
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        fontFamily: {
                            'poppins': ['Poppins', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                            'inter': ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        },
                        colors: {
                            'primary': '#3B82F6',
                            'primary-600': '#2563EB',
                            'mint': '#22C55E',
                            'accent': '#FACC15',
                            'bg': '#F9FAFB',
                            'text-primary': '#111827',
                            'muted': '#6B7280',
                            'danger': '#EF4444',
                            'card': '#ffffff',
                        },
                        borderRadius: {
                            'xl2': '1rem',
                        },
                        boxShadow: {
                            'card': '0 6px 20px rgba(13, 38, 59, 0.08)',
                            'card-hover': '0 12px 30px rgba(59, 130, 246, 0.12)',
                        },
                        animation: {
                            'float': 'float 6s ease-in-out infinite',
                            'glow': 'glow 2s ease-in-out infinite alternate',
                            'slide-up': 'slideUp 0.5s ease-out',
                            'fade-in': 'fadeIn 0.3s ease-in',
                            'scale-in': 'scaleIn 0.2s ease-out',
                            'bounce-gentle': 'bounceGentle 0.6s ease-out',
                        },
                        keyframes: {
                            float: {
                                '0%, 100%': { transform: 'translateY(0px)' },
                                '50%': { transform: 'translateY(-10px)' },
                            },
                            glow: {
                                '0%': { boxShadow: '0 0 5px #3B82F6' },
                                '100%': { boxShadow: '0 0 20px #3B82F6, 0 0 30px #3B82F1' },
                            },
                            slideUp: {
                                '0%': { transform: 'translateY(20px)', opacity: '0' },
                                '100%': { transform: 'translateY(0)', opacity: '1' },
                            },
                            fadeIn: {
                                '0%': { opacity: '0' },
                                '100%': { opacity: '1' },
                            },
                            scaleIn: {
                                '0%': { transform: 'scale(0.95)', opacity: '0' },
                                '100%': { transform: 'scale(1)', opacity: '1' },
                            },
                            bounceGentle: {
                                '0%': { transform: 'scale(0.3)' },
                                '50%': { transform: 'scale(1.05)' },
                                '70%': { transform: 'scale(0.9)' },
                                '100%': { transform: 'scale(1)' },
                            }
                        }
                    }
                }
            };
        } else {
            // Tailwind not loaded yet, try again after a delay
            setTimeout(function () {
                if (typeof tailwind !== 'undefined') {
                    tailwind.config = {
                        darkMode: 'class',
                        theme: {
                            extend: {
                                fontFamily: {
                                    'poppins': ['Poppins', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                                    'inter': ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                                },
                                colors: {
                                    'primary': '#3B82F6',
                                    'primary-600': '#2563EB',
                                    'mint': '#22C55E',
                                    'accent': '#FACC15',
                                    'bg': '#F9FAFB',
                                    'text-primary': '#111827',
                                    'muted': '#6B7280',
                                    'danger': '#EF4444',
                                    'card': '#ffffff',
                                },
                                borderRadius: {
                                    'xl2': '1rem',
                                },
                                boxShadow: {
                                    'card': '0 6px 20px rgba(13, 38, 59, 0.08)',
                                    'card-hover': '0 12px 30px rgba(59, 130, 246, 0.12)',
                                },
                                animation: {
                                    'float': 'float 6s ease-in-out infinite',
                                    'glow': 'glow 2s ease-in-out infinite alternate',
                                    'slide-up': 'slideUp 0.5s ease-out',
                                    'fade-in': 'fadeIn 0.3s ease-in',
                                    'scale-in': 'scaleIn 0.2s ease-out',
                                    'bounce-gentle': 'bounceGentle 0.6s ease-out',
                                },
                                keyframes: {
                                    float: {
                                        '0%, 100%': { transform: 'translateY(0px)' },
                                        '50%': { transform: 'translateY(-10px)' },
                                    },
                                    glow: {
                                        '0%': { boxShadow: '0 0 5px #3B82F6' },
                                        '100%': { boxShadow: '0 0 20px #3B82F6, 0 0 30px #3B82F1' },
                                    },
                                    slideUp: {
                                        '0%': { transform: 'translateY(20px)', opacity: '0' },
                                        '100%': { transform: 'translateY(0)', opacity: '1' },
                                    },
                                    fadeIn: {
                                        '0%': { opacity: '0' },
                                        '100%': { opacity: '1' },
                                    },
                                    scaleIn: {
                                        '0%': { transform: 'scale(0.95)', opacity: '0' },
                                        '100%': { transform: 'scale(1)', opacity: '1' },
                                    },
                                    bounceGentle: {
                                        '0%': { transform: 'scale(0.3)' },
                                        '50%': { transform: 'scale(1.05)' },
                                        '70%': { transform: 'scale(0.9)' },
                                        '100%': { transform: 'scale(1)' },
                                    }
                                }
                            }
                        }
                    };
                }
            }, 100);
        }
    </script>

    <!-- Global Styles -->
    <style>
        :root {
            --color-primary: #3B82F6;
            --color-primary-600: #2563EB;
            --color-mint: #22C55E;
            --color-accent: #FACC15;
            --bg: #F9FAFB;
            --text-primary: #111827;
            --muted: #6B7280;
            --danger: #EF4444;
            --card: #ffffff;
        }

        /* Dark Mode Variables */
        .dark {
            --bg: #0F172A;
            --text-primary: #F1F5F9;
            --muted: #94A3B8;
            --card: #1E293B;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Component Classes */
        .btn-primary {
            @apply inline-flex items-center gap-2 px-5 py-2 rounded-2xl text-white font-medium bg-gradient-to-r from-primary to-indigo-600 shadow-sm hover:scale-[1.01] transition-all duration-200;
        }

        .btn-ghost {
            @apply inline-flex items-center gap-2 px-5 py-2 rounded-2xl text-primary font-medium border border-primary/20 hover:bg-primary/5 transition-all duration-200;
        }

        .btn-icon {
            @apply p-2 rounded-xl text-muted hover:text-primary hover:bg-primary/5 transition-all duration-200;
        }

        .card {
            @apply bg-white rounded-2xl p-5 shadow-card hover:shadow-card-hover transition-all duration-200;
        }

        .card-hover {
            @apply hover:scale-[1.02] hover:-translate-y-1;
        }

        .badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
        }

        .badge-primary {
            @apply bg-blue-50 text-primary;
        }

        .badge-mint {
            @apply bg-green-50 text-mint;
        }

        .badge-accent {
            @apply bg-yellow-50 text-amber-600;
        }

        .badge-danger {
            @apply bg-red-50 text-danger;
        }

        .input-field {
            @apply w-full p-3 rounded-lg border border-gray-200 focus:border-primary focus:ring-1 focus:ring-primary/20 outline-none transition-all duration-200;
        }

        .avatar {
            @apply rounded-full border-2 border-white shadow-sm;
        }

        .avatar-online::after {
            content: '';
            @apply absolute bottom-0 right-0 w-3 h-3 bg-mint rounded-full ring-2 ring-white;
        }

        /* Chat Bubbles */
        .chat-bubble-poster {
            @apply bg-gradient-to-r from-primary to-indigo-600 text-white rounded-2xl rounded-br-md p-3 ml-auto max-w-xs;
        }

        .chat-bubble-doer {
            @apply bg-gray-100 text-gray-800 rounded-2xl rounded-bl-md p-3 mr-auto max-w-xs;
        }

        /* Skeleton Loaders */
        .skeleton {
            @apply animate-pulse bg-gray-200 rounded;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Focus Styles for Accessibility */
        .focus-ring:focus {
            @apply ring-2 ring-primary/40 ring-offset-2 outline-none;
        }

        /* Sidebar Styles */
        .sidebar-item {
            @apply flex items-center gap-3 px-4 py-3 rounded-xl text-gray-700 font-medium transition-all duration-200;
            background: white;
            border: 2px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .sidebar-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #3b82f6;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Table Styles */
        .table-row {
            @apply hover:bg-gray-50 transition-colors duration-150;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            @apply fixed inset-0 bg-black/50 backdrop-blur-md z-50 flex items-center justify-center p-4;
        }

        /* Toast Styles */
        .toast {
            @apply px-6 py-4 rounded-xl shadow-lg transform transition-transform duration-300 flex items-center space-x-2 max-w-sm;
        }

        .toast-success {
            @apply bg-mint text-white;
        }

        .toast-error {
            @apply bg-danger text-white;
        }

        .toast-warning {
            @apply bg-accent text-gray-800;
        }

        .toast-info {
            @apply bg-primary text-white;
        }

        /* Mobile Responsiveness Utilities */
        img,
        video {
            max-width: 100%;
            height: auto;
        }

        body {
            overflow-x: hidden;
        }

        /* Responsive Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-responsive table {
            min-width: 600px;
        }

        /* Touch-Friendly Buttons */
        button,
        a.btn,
        .btn {
            min-height: 44px;
            min-width: 44px;
        }

        /* Prevent text overflow */
        .text-truncate-mobile {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {

            /* Stack elements on mobile */
            .mobile-stack {
                flex-direction: column !important;
            }

            /* Full width on mobile */
            .mobile-full {
                width: 100% !important;
            }

            /* Hide on mobile */
            .mobile-hide {
                display: none !important;
            }
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>

<body class="bg-bg font-inter text-text-primary min-h-screen">
    <!-- Header -->
    {% if user.is_authenticated %}
    <header
        class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg border-b border-gray-200 dark:border-slate-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="{% url 'dashboard' %}" class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-r from-primary to-indigo-600 rounded-2xl flex items-center justify-center">
                            <span class="text-white font-bold text-lg">E</span>
                        </div>
                        <span class="font-poppins font-bold text-xl gradient-text hidden sm:block">ErrandExpress</span>
                        <span class="text-xl">ðŸš€</span>
                    </a>
                </div>

                <!-- Spacer -->
                <div class="flex-1"></div>

                <!-- Right Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Quick Post Task -->
                    {% if user.role == 'task_poster' or user.role == 'admin' %}
                    <a href="{% url 'create_task' %}" class="btn-primary hidden sm:inline-flex">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Post Task
                    </a>
                    {% endif %}

                    <!-- Dark Mode Toggle -->
                    <button id="theme-toggle" class="btn-icon" title="Toggle dark mode">
                        <i data-lucide="moon" class="w-5 h-5 dark-mode-icon"></i>
                        <i data-lucide="sun" class="w-5 h-5 light-mode-icon hidden"></i>
                    </button>

                    <!-- Notifications Dropdown (Desktop Only) -->
                    <div class="relative hidden lg:block" id="notifications-dropdown">
                        <button id="notifications-btn"
                            class="btn-icon relative hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors p-2">
                            <!-- Bell Icon with SVG Fallback -->
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                            <i data-lucide="bell" class="w-5 h-5 text-gray-700 dark:text-gray-300 hidden"></i>
                            <span id="notification-badge"
                                class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center hidden animate-pulse ring-2 ring-white dark:ring-slate-800 shadow-lg">0</span>
                        </button>

                        <!-- Dropdown Menu -->
                        <div id="notifications-menu"
                            class="hidden absolute lg:absolute fixed lg:right-0 lg:mt-2 right-2 lg:right-0 top-16 lg:top-auto left-2 lg:left-auto w-auto lg:w-96 lg:rounded-2xl rounded-xl bg-white dark:bg-slate-800 shadow-xl border border-gray-200 dark:border-slate-700 overflow-hidden z-50 lg:border-t-0 border-t lg:max-h-96 max-h-screen">
                            <!-- Header -->
                            <div
                                class="px-4 lg:px-4 py-4 lg:py-3 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between">
                                <h3 class="font-semibold text-gray-900 dark:text-white text-lg lg:text-base">
                                    Notifications</h3>
                                <a href="{% url 'notifications' %}"
                                    class="text-sm text-primary hover:text-primary-600">View All</a>
                            </div>

                            <!-- Notifications List -->
                            <div id="notifications-list"
                                class="max-h-96 lg:max-h-96 max-h-[calc(100vh-200px)] overflow-y-auto">
                                <!-- Loading state -->
                                <div id="notifications-loading" class="p-8 text-center">
                                    <div
                                        class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-2">
                                    </div>
                                    <p class="text-sm text-muted">Loading notifications...</p>
                                </div>

                                <!-- Empty state (hidden by default) -->
                                <div id="notifications-empty" class="hidden p-8 text-center">
                                    <i data-lucide="bell-off" class="w-12 h-12 text-muted mx-auto mb-2"></i>
                                    <p class="text-sm text-muted">No notifications yet</p>
                                </div>

                                <!-- Notifications will be inserted here -->
                            </div>

                            <!-- Footer -->
                            <div class="px-4 py-3 border-t border-gray-200 dark:border-slate-700 text-center">
                                <a href="{% url 'notifications' %}"
                                    class="text-sm text-primary hover:text-primary-600 font-medium">See All
                                    Notifications</a>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Menu -->
                    <div class="relative group">
                        <button class="flex items-center space-x-2 p-2 rounded-xl hover:bg-gray-100 transition-colors">
                            <div class="relative">
                                <div
                                    class="w-8 h-8 bg-gradient-to-r from-primary to-indigo-600 rounded-full flex items-center justify-center avatar">
                                    <span class="text-white font-semibold text-sm">{{ user.fullname.0|upper }}</span>
                                </div>
                                <span
                                    class="absolute bottom-0 right-0 w-3 h-3 bg-mint rounded-full ring-2 ring-white"></span>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-muted"></i>
                        </button>

                        <!-- Dropdown Menu -->
                        <div
                            class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-card border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                            <div class="p-2">
                                <a href="{% url 'profile' %}"
                                    class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                                    <i data-lucide="user" class="w-4 h-4"></i>
                                    <span>Profile</span>
                                </a>
                                <hr class="my-2">
                                <a href="{% url 'logout' %}"
                                    class="flex items-center space-x-2 p-2 rounded-lg hover:bg-red-50 text-danger transition-colors">
                                    <i data-lucide="log-out" class="w-4 h-4"></i>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    {% endif %}

    <!-- Mobile Navigation Bar (Enhanced Design) -->
    {% if user.is_authenticated %}
    <nav
        class="lg:hidden bg-white border-b border-gray-200 sticky top-0 z-40 flex items-center justify-between gap-1 overflow-x-auto px-1 py-3 shadow-sm">
        <a href="{% url 'dashboard' %}"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-blue-50 rounded-lg">
                <i data-lucide="home" class="w-5 h-5 text-primary"></i>
            </div>
            <span class="text-gray-600">Home</span>
        </a>
        {% if user.role == 'task_poster' %}
        <a href="{% url 'create_task' %}"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-green-50 rounded-lg">
                <i data-lucide="plus" class="w-5 h-5 text-green-600"></i>
            </div>
            <span class="text-gray-600">Post</span>
        </a>
        {% else %}
        <a href="{% url 'browse_tasks' %}"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-green-50 rounded-lg">
                <i data-lucide="search" class="w-5 h-5 text-green-600"></i>
            </div>
            <span class="text-gray-600">Browse</span>
        </a>
        {% endif %}
        <a href="{% url 'messages_list' %}"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-blue-50 rounded-lg">
                <i data-lucide="message-circle" class="w-5 h-5 text-primary"></i>
            </div>
            <span class="text-gray-600">Messages</span>
        </a>
        <a href="/payments/"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-purple-50 rounded-lg">
                <i data-lucide="credit-card" class="w-5 h-5 text-purple-600"></i>
            </div>
            <span class="text-gray-600">Payments</span>
        </a>
        <a href="{% url 'task_monitoring' %}"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-indigo-50 rounded-lg">
                <i data-lucide="chart-bar" class="w-5 h-5 text-indigo-600"></i>
            </div>
            <span class="text-gray-600">Monitor</span>
        </a>
        <a href="/notifications/"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95 relative">
            <div class="p-2 bg-orange-50 rounded-lg relative">
                <i data-lucide="bell" class="w-5 h-5 text-orange-600"></i>
                <span id="mobile-notification-badge"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden animate-pulse ring-1 ring-white">0</span>
            </div>
            <span class="text-gray-600">Alerts</span>
        </a>
        <a href="/profile/"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-semibold text-gray-700 hover:text-primary hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95">
            <div class="p-2 bg-red-50 rounded-lg">
                <i data-lucide="user" class="w-5 h-5 text-red-600"></i>
            </div>
            <span class="text-gray-600">Profile</span>
        </a>
        <a href="{% url 'logout' %}"
            class="flex flex-col items-center gap-1 px-3 py-2 text-xs font-bold text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-xl transition-all duration-200 flex-shrink-0 active:scale-95 shadow-md hover:shadow-lg ml-auto">
            <div class="p-2 bg-red-400 rounded-lg">
                <i data-lucide="log-out" class="w-5 h-5 text-white"></i>
            </div>
            <span class="text-white font-semibold">Logout</span>
        </a>
    </nav>
    {% endif %}

    <!-- Main Layout -->
    <div class="{% if user.is_authenticated %}layout grid{% endif %}">
        <!-- Sidebar -->
        {% if user.is_authenticated %}
        <aside
            class="sidebar w-72 bg-gradient-to-b from-gray-50 to-white border-r border-gray-200 fixed left-0 top-16 h-[calc(100vh-4rem)] overflow-y-auto z-30 hidden lg:block shadow-sm">
            <div class="p-6 relative h-full">

                <!-- User Profile Card -->
                <div class="mb-6 p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 bg-gradient-to-br from-primary to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                            {{ user.fullname|first|upper }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-500">
                                {% if user.role == 'task_poster' %}Task Poster
                                {% elif user.role == 'task_doer' %}Task Doer
                                {% else %}{{ user.role|title }}{% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Quick Stats Mini -->
                    <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-2 text-center">
                        <div>
                            <div class="text-lg font-bold text-primary">{{ user_stats.tasks_completed }}</div>
                            <div class="text-xs text-gray-500">Tasks</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-green-600">â‚±{{ user_stats.total_earned|floatformat:0 }}
                            </div>
                            <div class="text-xs text-gray-500">{% if user.role == 'task_doer' %}Earned{% else %}Spent{% endif %}</div>
                        </div>
                    </div>
                </div>

                <!-- Main Navigation -->
                <div class="mb-6">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4 px-2">Menu</p>
                    <nav class="flex flex-col space-y-2">
                        <a href="{% url 'dashboard' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                            <i data-lucide="home" class="w-5 h-5"></i>
                            <span>Dashboard</span>
                        </a>

                        {% if user.role == 'task_poster' %}
                        <a href="{% url 'create_task' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'create_task' %}active{% endif %}">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            <span>Post Task</span>
                        </a>
                        {% else %}
                        <a href="{% url 'browse_tasks' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'browse_tasks' %}active{% endif %}">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            <span>Browse Tasks</span>
                        </a>
                        {% endif %}

                        <a href="{% url 'notifications' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'notifications' %}active{% endif %}"
                            id="sidebar-notifications-link">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span>Notifications</span>
                            <span id="sidebar-notification-badge"
                                class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-semibold hidden">0</span>
                        </a>

                        <a href="{% url 'my_tasks' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'my_tasks' %}active{% endif %}">
                            <i data-lucide="list-checks" class="w-5 h-5"></i>
                            <span>My Tasks</span>
                        </a>

                        <a href="{% url 'messages_list' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'messages_list' %}active{% endif %}">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                            <span>Messages</span>
                        </a>

                        <a href="{% url 'payments_dashboard' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'payments_dashboard' %}active{% endif %}">
                            <i data-lucide="wallet" class="w-5 h-5"></i>
                            <span>Payments</span>
                        </a>

                        <a href="{% url 'task_monitoring' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'task_monitoring' %}active{% endif %}">
                            <i data-lucide="chart-bar" class="w-5 h-5"></i>
                            <span>Monitoring</span>
                        </a>

                        {% if user.role == 'task_doer' or user.role == 'admin' %}
                        <a href="{% url 'skill_validation' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'skill_validation' %}active{% endif %}">
                            <i data-lucide="award" class="w-5 h-5"></i>
                            <span>Validate Skills</span>
                        </a>
                        {% endif %}

                        <a href="{% url 'profile' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <span>Profile</span>
                        </a>
                    </nav>
                </div>

                <!-- Admin Section -->
                {% if user.role == 'admin' %}
                <div class="mb-6">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4 px-2">Admin</p>
                    <nav class="flex flex-col space-y-2">
                        <a href="{% url 'admin_dashboard' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
                            <i data-lucide="shield" class="w-5 h-5"></i>
                            <span>Admin Panel</span>
                        </a>
                        <a href="{% url 'system_wallet' %}"
                            class="sidebar-item {% if request.resolver_match.url_name == 'system_wallet' %}active{% endif %}">
                            <i data-lucide="wallet" class="w-5 h-5"></i>
                            <span>System Wallet</span>
                        </a>
                    </nav>
                </div>
                {% endif %}

                <!-- Logout at bottom -->
                <div class="absolute bottom-6 left-6 right-6">
                    <a href="{% url 'logout' %}" class="sidebar-item hover:bg-red-50 hover:text-red-600">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>
        {% endif %}

        <!-- Main Content -->
        <main class="{% if user.is_authenticated %}content ml-0 lg:ml-72 min-h-screen{% else %}min-h-screen{% endif %}">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Django Messages (converted to notifications) -->
    {% include 'includes/django_messages.html' %}

    <!-- Professional Notification System -->
    {% include 'includes/notifications.html' %}

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-white rounded-2xl p-8 text-center animate-scale-in">
            <div class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4">
            </div>
            <p class="text-muted">Loading...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Wait for DOM and libraries to load
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Initialize AOS animations
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 600,
                    easing: 'ease-out-cubic',
                    once: true
                });
            }
        });

        // Note: showToast/showNotification is now defined in includes/notifications.html

        // Loading overlay functions
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('flex');
        }

        // Notification count updater
        {% if user.is_authenticated %}
        async function updateNotificationCount() {
            try {
                const response = await fetch('/api/notification-count/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    console.warn('Notification API returned status:', response.status);
                    return;
                }

                const data = await response.json();
                const badge = document.getElementById('notification-badge');
                const sidebarBadge = document.getElementById('sidebar-notification-badge');

                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                // Also update sidebar badge
                if (sidebarBadge) {
                    if (data.count > 0) {
                        sidebarBadge.textContent = data.count > 99 ? '99+' : data.count;
                        sidebarBadge.classList.remove('hidden');
                    } else {
                        sidebarBadge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.warn('Failed to update notification count (non-critical):', error.message);
            }
        }

        // Update notification count on page load and every 30 seconds
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateNotificationCount);
        } else {
            updateNotificationCount();
        }
        setInterval(updateNotificationCount, 30000);
        {% endif %}

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Add hover effects to cards
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('mouseenter', function () {
                    if (this.classList.contains('card-hover')) {
                        this.style.transform = 'translateY(-4px) scale(1.02)';
                    }
                });

                card.addEventListener('mouseleave', function () {
                    if (this.classList.contains('card-hover')) {
                        this.style.transform = 'translateY(0) scale(1)';
                    }
                });
            });

            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');

            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('hidden');
                });
            }
        });

        // Django messages as toasts
        document.addEventListener('DOMContentLoaded', function () {
            {% for message in messages %}
            showToast('{{ message|escapejs }}', '{{ message.tags }}');
            {% endfor %}
        });

        // Notifications Dropdown
        (function () {
            const notificationsBtn = document.getElementById('notifications-btn');
            const notificationsMenu = document.getElementById('notifications-menu');
            const notificationsList = document.getElementById('notifications-list');
            const notificationBadge = document.getElementById('notification-badge');
            const notificationsLoading = document.getElementById('notifications-loading');
            const notificationsEmpty = document.getElementById('notifications-empty');

            let notificationsLoaded = false;

            // Toggle dropdown
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    notificationsMenu.classList.toggle('hidden');

                    // Load notifications on first open
                    if (!notificationsLoaded) {
                        loadNotifications();
                    }

                    // Mark notifications as read when user opens dropdown
                    if (!notificationsMenu.classList.contains('hidden')) {
                        markNotificationsAsRead();
                        notificationBadge.classList.add('hidden');
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (notificationsMenu && !notificationsMenu.contains(e.target) && e.target !== notificationsBtn) {
                    notificationsMenu.classList.add('hidden');
                }
            });

            // Load notifications via AJAX
            function loadNotifications() {
                fetch('/api/notifications/recent/')
                    .then(response => response.json())
                    .then(data => {
                        notificationsLoaded = true;
                        notificationsLoading.classList.add('hidden');

                        if (data.notifications && data.notifications.length > 0) {
                            renderNotifications(data.notifications);
                            updateBadge(data.unread_count);
                        } else {
                            notificationsEmpty.classList.remove('hidden');
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading notifications:', error);
                        notificationsLoading.innerHTML = '<p class="text-sm text-danger p-4">Failed to load notifications</p>';
                    });
            }

            // Render notifications
            function renderNotifications(notifications) {
                const html = notifications.map(notif => {
                    const icon = getNotificationIcon(notif.type);
                    const timeAgo = notif.time_ago || 'Just now';
                    const unreadClass = notif.is_read ? '' : 'bg-blue-50 dark:bg-slate-700/50';
                    const unreadDot = notif.is_read ? '' : '<span class="w-2 h-2 bg-primary rounded-full"></span>';

                    return `
                        <div class="px-4 lg:px-4 py-4 lg:py-3 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors border-b border-gray-100 dark:border-slate-700 ${unreadClass}">
                            <div class="flex items-start gap-3 lg:gap-3">
                                <div class="flex-shrink-0 text-2xl lg:text-2xl">${icon}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between gap-2">
                                        <p class="text-sm lg:text-sm font-medium text-gray-900 dark:text-white leading-snug">${notif.title}</p>
                                        ${unreadDot}
                                    </div>
                                    <p class="text-sm lg:text-sm text-gray-600 dark:text-gray-300 mt-2 lg:mt-1 leading-relaxed">${notif.message}</p>
                                    <p class="text-xs lg:text-xs text-muted mt-2 lg:mt-1">${timeAgo}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                notificationsList.innerHTML = html;
            }

            // Get icon for notification type
            function getNotificationIcon(type) {
                const icons = {
                    'task_assigned': 'ðŸ“‹',
                    'task_completed': 'âœ…',
                    'payment_received': 'ðŸ’°',
                    'rating_received': 'â­',
                    'skill_verified': 'ðŸŽ“',
                    'report_filed': 'ðŸš¨',
                    'system_message': 'ðŸ’¬'
                };
                return icons[type] || 'ðŸ“¢';
            }

            // Update badge
            function updateBadge(count) {
                if (count > 0) {
                    notificationBadge.textContent = count > 9 ? '9+' : count;
                    notificationBadge.classList.remove('hidden');

                    // Also update mobile badge
                    const mobileBadge = document.getElementById('mobile-notification-badge');
                    if (mobileBadge) {
                        mobileBadge.textContent = count > 9 ? '9+' : count;
                        mobileBadge.classList.remove('hidden');
                    }
                } else {
                    notificationBadge.classList.add('hidden');

                    // Hide mobile badge
                    const mobileBadge = document.getElementById('mobile-notification-badge');
                    if (mobileBadge) {
                        mobileBadge.classList.add('hidden');
                    }
                }
            }

            // Mark all notifications as read
            function markNotificationsAsRead() {
                fetch('/api/notifications/mark-as-read/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Hide both desktop and mobile badges
                        notificationBadge.classList.add('hidden');
                        const mobileBadge = document.getElementById('mobile-notification-badge');
                        if (mobileBadge) {
                            mobileBadge.classList.add('hidden');
                        }
                    })
                    .catch(error => console.warn('Could not mark notifications as read:', error));
            }

            // Poll for new notifications every 30 seconds
            setInterval(function () {
                if (notificationsLoaded) {
                    fetch('/api/notifications/count/')
                        .then(response => response.json())
                        .then(data => {
                            updateBadge(data.unread_count);
                        })
                        .catch(error => console.error('Error checking notifications:', error));
                }
            }, 30000);
        })();

        // Dark Mode Toggle
        (function () {
            const htmlRoot = document.getElementById('html-root');
            const themeToggle = document.getElementById('theme-toggle');
            const darkModeIcon = document.querySelector('.dark-mode-icon');
            const lightModeIcon = document.querySelector('.light-mode-icon');

            // Check for saved theme preference or default to light mode
            const currentTheme = localStorage.getItem('theme') || 'light';

            // Apply theme on page load
            if (currentTheme === 'dark') {
                htmlRoot.classList.add('dark');
                if (darkModeIcon) darkModeIcon.classList.add('hidden');
                if (lightModeIcon) lightModeIcon.classList.remove('hidden');
            }

            // Toggle theme on button click
            if (themeToggle) {
                themeToggle.addEventListener('click', function () {
                    const isDark = htmlRoot.classList.contains('dark');

                    if (isDark) {
                        // Switch to light mode
                        htmlRoot.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                        if (darkModeIcon) darkModeIcon.classList.remove('hidden');
                        if (lightModeIcon) lightModeIcon.classList.add('hidden');
                    } else {
                        // Switch to dark mode
                        htmlRoot.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                        if (darkModeIcon) darkModeIcon.classList.add('hidden');
                        if (lightModeIcon) lightModeIcon.classList.remove('hidden');
                    }

                    // Reinitialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
            }
        })();
    </script>

    {% block extra_scripts %}{% endblock %}
</body>

</html>