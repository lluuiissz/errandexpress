{% extends 'base_complete.html' %}
{% load static %}

{% block title %}Rate User - ErrandExpress{% endblock %}

{% block extra_css %}
<style>
    /* Premium Animations & Glassmorphism */
    @keyframes float {
        0% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-10px);
        }

        100% {
            transform: translateY(0px);
        }
    }

    .animate-float {
        animation: float 6s ease-in-out infinite;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .glass-input {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(203, 213, 225, 0.8);
        transition: all 0.3s ease;
    }

    .glass-input:focus {
        background: rgba(255, 255, 255, 1);
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Custom form styling */
    select.glass-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
</style>
{% endblock %}

{% block content %}
<div
    class="min-h-screen bg-gradient-to-br from-blue-600 via-indigo-700 to-purple-800 py-12 px-4 relative overflow-hidden flex items-center justify-center">

    <!-- Decorative Elements -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="absolute top-[10%] left-[10%] w-72 h-72 bg-blue-400/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute bottom-[20%] right-[10%] w-96 h-96 bg-purple-500/20 rounded-full blur-3xl animate-pulse"
            style="animation-delay: 2s;"></div>
    </div>

    <div class="max-w-5xl w-full grid lg:grid-cols-5 gap-8 items-start relative z-10">

        <!-- Left Column: Context (User & Task) -->
        <div class="lg:col-span-2 text-white lg:sticky lg:top-8 pt-4 space-y-6">

            <a href="{% url 'task_detail' task.id %}"
                class="inline-flex items-center gap-2 text-indigo-200 hover:text-white transition-colors mb-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Task
            </a>

            <div>
                <h1 class="text-4xl font-extrabold mb-2 leading-tight drop-shadow-md">Rate Your Experience</h1>
                <p class="text-indigo-100 text-lg leading-relaxed">
                    Help the community by sharing your feedback about this transaction.
                </p>
            </div>

            <!-- Rated User Profile Card -->
            <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20">
                <div class="flex items-center gap-4 mb-4">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                        {{ rated_user.fullname|first|upper }}
                    </div>
                    <div>
                        <h3 class="font-bold text-xl">{{ rated_user.fullname }}</h3>
                        <div class="flex items-center gap-2 text-indigo-200 text-sm">
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-medium">
                                {% if rated_user.role == 'task_poster' %}Poster{% else %}Doer{% endif %}
                            </span>
                            <span>•</span>
                            <span>{{ rated_user.avg_rating|default:"New" }} ⭐</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Info Card -->
            <div
                class="bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20 group hover:bg-white/15 transition-all">
                <h3 class="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-3">Task Details</h3>
                <h2 class="font-bold text-lg mb-2">{{ task.title }}</h2>

                <div class="flex flex-wrap gap-3 text-sm text-indigo-100">
                    <span class="flex items-center gap-1.5 bg-white/10 px-3 py-1 rounded-full"><i data-lucide="tag"
                            class="w-3.5 h-3.5"></i> {{ task.get_category_display }}</span>
                    <span class="flex items-center gap-1.5 bg-white/10 px-3 py-1 rounded-full"><i data-lucide="map-pin"
                            class="w-3.5 h-3.5"></i> {{ task.location }}</span>
                    <span
                        class="flex items-center gap-1.5 bg-emerald-500/20 text-emerald-300 px-3 py-1 rounded-full font-bold">₱{{ task.price }}</span>
                </div>
            </div>
        </div>

        <!-- Right Column: Action (Form or Payment) -->
        <div class="lg:col-span-3">
            <div class="glass-card rounded-3xl p-6 md:p-8 animate-float shadow-2xl">

                {% if already_rated %}
                <!-- State 1: Already Rated -->
                <div class="text-center py-8">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="check-circle" class="w-10 h-10 text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Rating Submitted</h2>
                    <p class="text-gray-600 mb-8">Thank you for rating {{ rated_user.fullname }}!</p>

                    <div class="bg-gray-50 rounded-xl p-6 text-left border border-gray-100 mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-500 text-sm">Your Rating</span>
                            <span class="text-3xl font-bold text-amber-500">{{ existing_rating.score }}/10</span>
                        </div>
                        {% if existing_rating.feedback %}
                        <div class="bg-white p-4 rounded-lg border border-gray-100 text-gray-700 italic">
                            "{{ existing_rating.feedback }}"
                        </div>
                        {% endif %}
                    </div>

                    <a href="{% url 'task_detail' task.id %}"
                        class="inline-flex items-center justify-center w-full bg-gray-900 text-white px-6 py-4 rounded-xl font-bold hover:bg-gray-800 transition-all">
                        Back to Task Details
                    </a>
                </div>

                {% elif payment_pending_verification %}
                <!-- State 2: Payment Pending Verification (COD) -->
                <div id="verification-pending-section">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 shrink-0">
                            <i data-lucide="clock" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Awaiting Payment Confirmation</h2>
                            <p class="text-sm text-gray-500">Waiting for {{ rated_user.fullname }} to confirm receipt.
                            </p>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-6 mb-8">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shrink-0">
                                <i data-lucide="info" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-2">Payment Status: Pending Verification</h3>
                                <p class="text-gray-700 text-sm leading-relaxed mb-3">
                                    You have marked the payment as <strong>Cash on Delivery (COD)</strong>. The task
                                    doer must confirm they received the payment before you can submit a rating.
                                </p>
                                <div class="bg-white rounded-lg p-3 border border-blue-200">
                                    <div class="flex items-center gap-2 text-sm">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                                        <span class="text-gray-600">Payment marked as COD</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm mt-2">
                                        <i data-lucide="loader" class="w-4 h-4 text-blue-600 animate-spin"></i>
                                        <span class="text-gray-600">Waiting for doer confirmation...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <p class="text-gray-500 text-sm mb-4">You'll be notified once {{ rated_user.fullname }} confirms
                            receipt.</p>
                        <a href="{% url 'task_detail' task.id %}"
                            class="inline-flex items-center justify-center w-full bg-gray-900 text-white px-6 py-4 rounded-xl font-bold hover:bg-gray-800 transition-all">
                            Back to Task Details
                        </a>
                    </div>
                </div>

                {% elif user == task.poster and rated_user == task.doer and not payment_completed %}
                <!-- State 2: Payment Required -->
                <div id="payment-section">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600 shrink-0">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Complete Payment First</h2>
                            <p class="text-sm text-gray-500">You must pay the task doer before rating.</p>
                        </div>
                    </div>

                    <div
                        class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-100 rounded-xl p-6 mb-8">
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-sm text-amber-800 font-medium mb-1">Amount Due</p>
                                <p class="text-3xl font-black text-gray-900 tracking-tight">₱{{ task.price }}</p>
                            </div>
                            <div class="text-right">
                                <span
                                    class="bg-white px-2 py-1 rounded text-xs font-bold text-amber-600 border border-amber-100">PENDING</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="openPaymentModal('{{ task.id }}', '{{ task.price }}')"
                            class="w-full relative group overflow-hidden bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-500/25 flex items-center justify-center gap-3">
                            <i data-lucide="smartphone" class="w-5 h-5"></i>
                            <span>Pay via GCash</span>
                        </button>

                        <button onclick="openPaymentModal('{{ task.id }}', '{{ task.price }}', 'cod')"
                            class="w-full bg-white text-gray-700 border border-gray-200 p-4 rounded-xl font-bold hover:bg-gray-50 hover:border-gray-300 transition-all flex items-center justify-center gap-3">
                            <i data-lucide="banknote" class="w-5 h-5"></i>
                            <span>Mark as Cash on Delivery (COD)</span>
                        </button>
                    </div>
                </div>

                {% else %}
                <!-- State 3: Rating Form -->
                <div>
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600">
                            <i data-lucide="star" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Submit Review</h2>
                            <p class="text-gray-500 text-sm">Valid assessment of the work done.</p>
                        </div>
                    </div>

                    <form method="post" class="space-y-6">
                        {% csrf_token %}

                        <!-- Score Input -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 ml-1">Rating Score</label>
                            <div class="relative">
                                {{ form.score }}
                                <div class="absolute right-4 top-3.5 pointer-events-none text-gray-400">
                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 ml-1">Select a score from 1 (Poor) to 10 (Excellent)</p>
                        </div>

                        <!-- Feedback Input -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 ml-1">Your Feedback</label>
                            {{ form.feedback }}
                            <p class="text-xs text-gray-500 ml-1">Be honest and constructive.</p>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="submit"
                                class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-blue-500/25 hover:from-blue-700 hover:to-indigo-700 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="send" class="w-5 h-5"></i> Submit Rating
                            </button>
                            <a href="{% url 'task_detail' task.id %}"
                                class="px-6 py-4 rounded-xl font-bold text-gray-600 hover:bg-gray-100 transition-colors">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Include Payment Modal -->
{% include 'payments/payment_modal.html' %}

<script>
    // Initialize icons
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Add glass classes to form widgets generated by Django
        const selects = document.querySelectorAll('select');
        selects.forEach(el => {
            el.classList.add('glass-input', 'w-full', 'p-3', 'rounded-xl', 'outline-none', 'text-gray-800', 'font-medium', 'bg-white/50');
        });

        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(el => {
            el.classList.add('glass-input', 'w-full', 'p-4', 'rounded-xl', 'outline-none', 'text-gray-800', 'min-h-[120px]', 'bg-white/50');
        });
    });

    // Payment listeners
    window.addEventListener('payment-completed', function (event) {
        // Refresh to show rating form
        setTimeout(() => window.location.reload(), 1500);
    });

    window.addEventListener('cod-payment-confirmed', function (event) {
        setTimeout(() => window.location.reload(), 1500);
    });
</script>

<!-- Scripts -->
<script src="{% static 'js/messages-payment.js' %}"></script>
{% endblock %}