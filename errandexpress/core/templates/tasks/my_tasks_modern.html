{% extends 'base_complete.html' %}
{% load static %}

{% block title %}My Tasks - ErrandExpress{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 pb-20 relative overflow-hidden">

    <!-- Decorative Elements -->
    <div
        class="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-b from-blue-100/40 to-transparent -z-10 pointer-events-none">
    </div>
    <div class="absolute top-20 right-0 w-96 h-96 bg-indigo-200/20 rounded-full blur-3xl pointer-events-none"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 relative z-10">

        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight mb-2 flex items-center gap-3">
                    {% if user.role == 'task_poster' %}
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-blue-600">My Posted
                        Tasks</span>
                    {% else %}
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-blue-600">My Accepted
                        Tasks</span>
                    {% endif %}
                </h1>
                <p class="text-slate-500 font-medium text-lg">
                    {% if user.role == 'task_poster' %}
                    Manage your active requests and track progress
                    {% else %}
                    Track your jobs and monitor your earnings
                    {% endif %}
                </p>
            </div>

            {% if user.role == 'task_poster' %}
            <a href="{% url 'create_task' %}"
                class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                Post New Task
            </a>
            {% else %}
            <a href="{% url 'browse_tasks' %}"
                class="inline-flex items-center gap-2 px-6 py-3 bg-white text-indigo-600 hover:bg-indigo-50 border border-indigo-100 rounded-xl font-bold shadow-sm hover:shadow-md transition-all duration-300">
                <i data-lucide="search" class="w-5 h-5"></i>
                Browse Tasks
            </a>
            {% endif %}
        </div>

        <!-- Dashboard Stats / Filters -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
            <!-- All Tasks -->
            <button
                class="filter-tab active group relative overflow-hidden bg-white/70 backdrop-blur-md border border-white/60 p-5 rounded-2xl shadow-sm hover:shadow-md transition-all text-left"
                data-filter="all">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-indigo-50/50 to-transparent opacity-0 group-[.active]:opacity-100 transition-opacity">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mb-3 group-[.active]:bg-indigo-600 group-[.active]:text-white transition-colors">
                        <i data-lucide="layers" class="w-5 h-5"></i>
                    </div>
                    <div class="text-slate-500 text-sm font-semibold mb-0.5 group-[.active]:text-indigo-700">All Tasks
                    </div>
                    <div class="text-2xl font-bold text-slate-900">{{ tasks.paginator.count }}</div>
                </div>
            </button>

            <!-- Open / Accepted -->
            <button
                class="filter-tab group relative overflow-hidden bg-white/70 backdrop-blur-md border border-white/60 p-5 rounded-2xl shadow-sm hover:shadow-md transition-all text-left"
                data-filter="{% if user.role == 'task_poster' %}open{% else %}accepted{% endif %}">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-blue-50/50 to-transparent opacity-0 group-[.active]:opacity-100 transition-opacity">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mb-3 group-[.active]:bg-blue-600 group-[.active]:text-white transition-colors">
                        {% if user.role == 'task_poster' %}
                        <i data-lucide="circle-dot" class="w-5 h-5"></i>
                        {% else %}
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                        {% endif %}
                    </div>
                    {% if user.role == 'task_poster' %}
                    <div class="text-slate-500 text-sm font-semibold mb-0.5 group-[.active]:text-blue-700">Open</div>
                    <div class="text-2xl font-bold text-slate-900">{{ status_counts.open }}</div>
                    {% else %}
                    <div class="text-slate-500 text-sm font-semibold mb-0.5 group-[.active]:text-blue-700">Accepted
                    </div>
                    <div class="text-2xl font-bold text-slate-900">{{ status_counts.accepted }}</div>
                    {% endif %}
                </div>
            </button>

            <!-- In Progress -->
            <button
                class="filter-tab group relative overflow-hidden bg-white/70 backdrop-blur-md border border-white/60 p-5 rounded-2xl shadow-sm hover:shadow-md transition-all text-left"
                data-filter="in_progress">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-amber-50/50 to-transparent opacity-0 group-[.active]:opacity-100 transition-opacity">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-10 h-10 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center mb-3 group-[.active]:bg-amber-500 group-[.active]:text-white transition-colors">
                        <i data-lucide="loader" class="w-5 h-5"></i>
                    </div>
                    <div class="text-slate-500 text-sm font-semibold mb-0.5 group-[.active]:text-amber-700">In Progress
                    </div>
                    <div class="text-2xl font-bold text-slate-900">{{ status_counts.in_progress }}</div>
                </div>
            </button>

            <!-- Completed -->
            <button
                class="filter-tab group relative overflow-hidden bg-white/70 backdrop-blur-md border border-white/60 p-5 rounded-2xl shadow-sm hover:shadow-md transition-all text-left"
                data-filter="completed">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-emerald-50/50 to-transparent opacity-0 group-[.active]:opacity-100 transition-opacity">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center mb-3 group-[.active]:bg-emerald-500 group-[.active]:text-white transition-colors">
                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                    </div>
                    <div class="text-slate-500 text-sm font-semibold mb-0.5 group-[.active]:text-emerald-700">Completed
                    </div>
                    <div class="text-2xl font-bold text-slate-900">{{ status_counts.completed }}</div>
                </div>
            </button>
        </div>

        <!-- Task List Header -->
        <div class="flex items-center justify-between mb-6 px-2">
            <h2 class="text-lg font-bold text-slate-800">
                Active Tasks (<span id="showing-count" class="text-indigo-600">{{ tasks.paginator.count }}</span>)
            </h2>
            <!-- Optional Sorting dropdown could go here -->
        </div>

        <!-- Tasks Grid -->
        <div class="grid gap-6">
            {% for task in tasks %}
            <div class="task-card group relative bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-xl hover:border-indigo-100 hover:-translate-y-1 transition-all duration-300"
                data-status="{{ task.status }}">

                <!-- Status Badge -->
                <div class="absolute top-6 right-6">
                    {% if task.status == 'open' %}
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">
                        <span class="w-2 h-2 rounded-full bg-green-500 mr-1.5 animate-pulse"></span> Open
                    </span>
                    {% elif task.status == 'in_progress' %}
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200">
                        <i data-lucide="clock" class="w-3 h-3 mr-1.5"></i> In Progress
                    </span>
                    {% elif task.status == 'completed' %}
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 border border-indigo-200">
                        <i data-lucide="check-check" class="w-3 h-3 mr-1.5"></i> Completed
                    </span>
                    {% else %}
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200">
                        {{ task.get_status_display }}
                    </span>
                    {% endif %}
                </div>

                <div class="flex items-start gap-5 pr-24">
                    <!-- Category Icon -->
                    <div
                        class="w-14 h-14 rounded-2xl bg-slate-50 border border-slate-100 flex items-center justify-center shrink-0 group-hover:bg-indigo-50 group-hover:border-indigo-100 transition-colors">
                        {% if task.category == 'delivery' %}
                        <i data-lucide="truck"
                            class="w-7 h-7 text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                        {% elif task.category == 'shopping' %}
                        <i data-lucide="shopping-bag"
                            class="w-7 h-7 text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                        {% elif task.category == 'cleaning' %}
                        <i data-lucide="sparkles"
                            class="w-7 h-7 text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                        {% else %}
                        <i data-lucide="briefcase"
                            class="w-7 h-7 text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                        {% endif %}
                    </div>

                    <div class="flex-1 min-w-0">
                        <h3
                            class="text-xl font-bold text-slate-900 mb-1 group-hover:text-indigo-600 transition-colors truncate">
                            {{ task.title }}
                        </h3>
                        <div class="flex items-center gap-3 text-sm text-slate-500 mb-4">
                            <span class="flex items-center gap-1.5">
                                <i data-lucide="tag" class="w-4 h-4 text-slate-400"></i> {{ task.get_category_display }}
                            </span>
                            <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                            <span class="flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i> {{ task.deadline|date:"M d, Y" }}
                            </span>
                        </div>

                        <!-- Description truncated -->
                        <p class="text-slate-600 mb-5 line-clamp-2 leading-relaxed">
                            {{ task.description }}
                        </p>

                        <!-- Footer Meta -->
                        <div
                            class="flex items-center justify-between pt-5 border-t border-slate-50 group-hover:border-indigo-50/50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl font-bold text-indigo-600">â‚±{{ task.price|floatformat:0 }}</div>

                                {% if task.doer and user.role == 'task_poster' %}
                                <div
                                    class="flex items-center gap-2 px-3 py-1 bg-slate-50 rounded-lg text-sm font-medium text-slate-600">
                                    <span class="text-slate-400">Doer:</span> {{ task.doer.fullname }}
                                </div>
                                {% endif %}
                            </div>

                            <a href="{% url 'task_detail' task.id %}"
                                class="inline-flex items-center gap-2 text-sm font-bold text-indigo-600 hover:text-indigo-700">
                                View Details <i data-lucide="arrow-right"
                                    class="w-4 h-4 transition-transform group-hover:translate-x-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div
                class="bg-white/50 backdrop-blur-sm rounded-3xl border border-dashed border-slate-200 p-12 text-center col-span-full">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="clipboard-x" class="w-10 h-10 text-slate-300"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">No Tasks Found</h3>
                <p class="text-slate-500 mb-6 max-w-md mx-auto">
                    {% if user.role == 'task_poster' %}
                    You haven't posted any tasks yet. Create one now to get help!
                    {% else %}
                    You haven't accepted any tasks yet. Browse the marketplace to find work.
                    {% endif %}
                </p>
                {% if user.role == 'task_poster' %}
                <a href="{% url 'create_task' %}"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all">Post
                    a Task</a>
                {% else %}
                <a href="{% url 'browse_tasks' %}"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all">Find
                    Tasks</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if tasks.has_other_pages %}
        <div class="mt-12 flex justify-center">
            <nav class="inline-flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 gap-1">
                {% if tasks.has_previous %}
                <a href="?page=1"
                    class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors">First</a>
                <a href="?page={{ tasks.previous_page_number }}"
                    class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors">Prev</a>
                {% endif %}

                <span
                    class="px-5 py-2 text-sm font-bold text-white bg-indigo-600 rounded-xl shadow-md shadow-indigo-200 mx-1">
                    {{ tasks.number }} <span class="opacity-60 font-normal">/ {{ tasks.paginator.num_pages }}</span>
                </span>

                {% if tasks.has_next %}
                <a href="?page={{ tasks.next_page_number }}"
                    class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors">Next</a>
                <a href="?page={{ tasks.paginator.num_pages }}"
                    class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors">Last</a>
                {% endif %}
            </nav>
        </div>
        {% endif %}

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        lucide.createIcons();

        // Stats Card Filtering Logic
        const filterTabs = document.querySelectorAll('.filter-tab');
        const taskCards = document.querySelectorAll('.task-card');
        const countDisplay = document.getElementById('showing-count');

        filterTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active state visuals
                filterTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const filter = tab.dataset.filter;
                let visibleCount = 0;

                taskCards.forEach(card => {
                    const status = card.dataset.status;

                    // Logic: 'all' shows everything. 'open', 'in_progress', 'completed' match status.
                    // 'accepted' matches status != 'open' AND != 'completed' (simplified) OR specifically 'accepted' if that status exists.
                    // Actually, let's rely on data-status matching filter exact string, EXCEPT for edge cases.

                    let match = false;
                    if (filter === 'all') {
                        match = true;
                    } else if (filter === status) {
                        match = true;
                    } else if (filter === 'accepted' && (status === 'in_progress' || status === 'accepted')) {
                        // 'Accepted' tab for Doers usually implies active jobs not yet completed? 
                        // Or if the filter tab specifically counts 'accepted' status. 
                        // The django view sends 'accepted' count for tasks where status='accepted'.
                        // Let's assume strict matching first, but grouped if needed.
                        match = true;
                    }

                    // Strict matching based on the buttons created
                    if (filter === 'all' || filter === status) {
                        card.style.display = 'block';
                        // Add fade-in animation
                        card.animate([
                            { opacity: 0, transform: 'translateY(10px)' },
                            { opacity: 1, transform: 'translateY(0)' }
                        ], { duration: 300, easing: 'ease-out' });
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                if (countDisplay) countDisplay.textContent = visibleCount;
            });
        });
    });
</script>
{% endblock %}