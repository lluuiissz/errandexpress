{% extends 'base_complete.html' %}

{% block title %}My Tasks - ErrandExpress{% endblock %}

{% block extra_css %}
<style>
    .task-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        border: 2px solid #f3f4f6;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .task-card:hover {
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12);
        transform: translateY(-4px);
        border-color: #3b82f6;
    }
    .status-open { border-left: 6px solid #22c55e; }
    .status-in_progress { border-left: 6px solid #f59e0b; }
    .status-completed { border-left: 6px solid #3b82f6; }
    .status-cancelled { border-left: 6px solid #ef4444; }
    .status-accepted { border-left: 6px solid #8b5cf6; }
    
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 2px solid #f3f4f6;
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                        <i data-lucide="clipboard-list" class="w-8 h-8 text-primary"></i>
                        {% if user.role == 'task_poster' %}
                            My Posted Tasks
                        {% else %}
                            My Accepted Tasks
                        {% endif %}
                    </h1>
                    <p class="text-gray-600 mt-1">
                        {% if user.role == 'task_poster' %}
                            Manage and track your posted tasks
                        {% else %}
                            Track your accepted tasks and earnings
                        {% endif %}
                    </p>
                </div>
                {% if user.role == 'task_poster' %}
                <a href="{% url 'create_task' %}" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    Post New Task
                </a>
                {% else %}
                <a href="{% url 'browse_tasks' %}" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                    <i data-lucide="search" class="w-5 h-5"></i>
                    Browse Tasks
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Filter Section -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border-2 border-gray-100 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                    <i data-lucide="filter" class="w-5 h-5 text-primary"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-gray-900">Filter Tasks</h2>
                    <p class="text-sm text-gray-600">
                        Showing <span id="showing-count" class="font-semibold text-primary">0</span> of {{ tasks.paginator.count }} tasks
                    </p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <button class="filter-tab active" data-filter="all">
                    <i data-lucide="inbox" class="w-5 h-5"></i>
                    <div class="flex flex-col items-start">
                        <span class="font-semibold">All Tasks</span>
                        <span class="text-xs opacity-75">{{ tasks.paginator.count }}</span>
                    </div>
                </button>
                <button class="filter-tab" data-filter="open">
                    <i data-lucide="circle-dot" class="w-5 h-5"></i>
                    <div class="flex flex-col items-start">
                        <span class="font-semibold">Open</span>
                        <span class="text-xs opacity-75">{{ status_counts.open }}</span>
                    </div>
                </button>
                <button class="filter-tab" data-filter="in_progress">
                    <i data-lucide="clock" class="w-5 h-5"></i>
                    <div class="flex flex-col items-start">
                        <span class="font-semibold">In Progress</span>
                        <span class="text-xs opacity-75">{{ status_counts.in_progress }}</span>
                    </div>
                </button>
                <button class="filter-tab" data-filter="completed">
                    <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                    <div class="flex flex-col items-start">
                        <span class="font-semibold">Completed</span>
                        <span class="text-xs opacity-75">{{ status_counts.completed }}</span>
                    </div>
                </button>
                <button class="filter-tab" data-filter="accepted">
                    <i data-lucide="user-check" class="w-5 h-5"></i>
                    <div class="flex flex-col items-start">
                        <span class="font-semibold">Accepted</span>
                        <span class="text-xs opacity-75">{{ status_counts.accepted }}</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Tasks List -->
        <div class="space-y-4">
            {% for task in tasks %}
            <div class="task-card status-{{ task.status }}" data-status="{{ task.status }}">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-xl font-bold text-gray-900">
                                <a href="{% url 'task_detail' task.id %}" class="hover:text-primary transition-colors">
                                    {{ task.title }}
                                </a>
                            </h3>
                            {% if task.status == 'open' %}
                            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">Open</span>
                            {% elif task.status == 'in_progress' %}
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">In Progress</span>
                            {% elif task.status == 'completed' %}
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">Completed</span>
                            {% else %}
                            <span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">{{ task.get_status_display }}</span>
                            {% endif %}
                        </div>
                        <p class="text-gray-600 mb-3">{{ task.description|truncatewords:30 }}</p>
                        
                        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                            <div class="flex items-center gap-1">
                                <i data-lucide="tag" class="w-4 h-4"></i>
                                <span>{{ task.get_category_display }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>Deadline: {{ task.deadline|date:"M d, Y" }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                <span>Posted: {{ task.created_at|timesince }} ago</span>
                            </div>
                            {% if task.doer and user.role == 'task_poster' %}
                            <div class="flex items-center gap-1">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                <span>Doer: {{ task.doer.fullname }}</span>
                            </div>
                            {% endif %}
                            {% if task.poster and user.role == 'task_doer' %}
                            <div class="flex items-center gap-1">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                <span>Poster: {{ task.poster.fullname }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if task.tags %}
                        <div class="flex flex-wrap gap-2 mt-3">
                            {% for tag in task.get_tags_list %}
                            <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="text-right ml-4">
                        <div class="text-3xl font-bold text-primary mb-2">â‚±{{ task.price }}</div>
                        <a href="{% url 'task_detail' task.id %}" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                            View Details
                            <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Status-specific info -->
                {% if task.status == 'open' and user.role == 'task_poster' %}
                <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2 text-sm text-green-800">
                    <i data-lucide="info" class="w-4 h-4"></i>
                    <span>Waiting for someone to accept this task</span>
                </div>
                {% elif task.status == 'in_progress' %}
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center gap-2 text-sm text-yellow-800">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>Task is currently in progress</span>
                </div>
                {% elif task.status == 'completed' %}
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-2 text-sm text-blue-800">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>Task completed successfully</span>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="text-center py-16">
                <i data-lucide="inbox" class="w-20 h-20 mx-auto mb-4 text-gray-300"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Tasks Found</h3>
                <p class="text-gray-600 mb-6">
                    {% if user.role == 'task_poster' %}
                        You haven't posted any tasks yet. Start by creating your first task!
                    {% else %}
                        You haven't accepted any tasks yet. Browse available tasks to get started!
                    {% endif %}
                </p>
                {% if user.role == 'task_poster' %}
                <a href="{% url 'create_task' %}" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Post Your First Task
                </a>
                {% else %}
                <a href="{% url 'browse_tasks' %}" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    <i data-lucide="search" class="w-5 h-5 mr-2"></i>
                    Browse Available Tasks
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if tasks.has_other_pages %}
        <div class="mt-8 flex justify-center">
            <nav class="flex items-center gap-2">
                {% if tasks.has_previous %}
                <a href="?page=1" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700">
                    First
                </a>
                <a href="?page={{ tasks.previous_page_number }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700">
                    Previous
                </a>
                {% endif %}
                
                <span class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium">
                    Page {{ tasks.number }} of {{ tasks.paginator.num_pages }}
                </span>
                
                {% if tasks.has_next %}
                <a href="?page={{ tasks.next_page_number }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700">
                    Next
                </a>
                <a href="?page={{ tasks.paginator.num_pages }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700">
                    Last
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Reset filters function
function resetFilters() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const taskCards = document.querySelectorAll('.task-card');
    
    // Reset to "All" filter
    filterTabs.forEach(t => t.classList.remove('active'));
    if (filterTabs[0]) filterTabs[0].classList.add('active');
    
    // Show all tasks
    taskCards.forEach(card => {
        card.style.display = 'block';
    });
    
    // Update count
    if (document.getElementById('showing-count')) {
        document.getElementById('showing-count').textContent = taskCards.length;
    }
    
    lucide.createIcons();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
    
    const filterTabs = document.querySelectorAll('.filter-tab');
    const taskCards = document.querySelectorAll('.task-card');
    
    // Set initial showing count
    if (document.getElementById('showing-count')) {
        document.getElementById('showing-count').textContent = taskCards.length;
    }
    
    // Make entire task card clickable
    taskCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't trigger if clicking on a link or button
            if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON' && !e.target.closest('a')) {
                const link = this.querySelector('a[href*="task_detail"]');
                if (link) {
                    window.location.href = link.href;
                }
            }
        });
    });
    
    // Filter functionality
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const filter = this.dataset.filter;
            
            // Update active tab
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Filter tasks and count visible
            let visibleCount = 0;
            taskCards.forEach(card => {
                if (filter === 'all' || card.dataset.status === filter) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update showing count
            if (document.getElementById('showing-count')) {
                document.getElementById('showing-count').textContent = visibleCount;
            }
        });
    });
});
</script>

<style>
.filter-tab {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    color: #6b7280;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
    cursor: pointer;
    text-align: left;
}

.filter-tab:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.filter-tab.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.filter-tab.active:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.filter-tab i {
    flex-shrink: 0;
}
</style>
{% endblock %}
