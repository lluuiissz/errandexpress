{% extends 'base_complete.html' %}
{% load static %}

{% block title %}Applications for {{ task.title }}{% endblock %}

{% block content %}
<div class='min-h-screen bg-gray-50 pb-20'>
    <!-- Hero Section -->
    <div class='bg-gradient-to-r from-indigo-900 to-blue-800 pt-24 pb-32 px-6'>
        <div class='max-w-7xl mx-auto'>
            <!-- Breadcrumb & Back -->
            <div class='mb-6 flex items-center justify-between'>
                <a href='{% url 'task_detail' task.id %}'
                    class='inline-flex items-center text-blue-200 hover:text-white transition-colors'>
                    <i data-lucide='arrow-left' class='w-4 h-4 mr-2'></i> Back to Task
                </a>
            </div>

            <div class='flex flex-col md:flex-row md:items-end justify-between gap-6'>
                <div>
                    <h1 class='text-3xl md:text-4xl font-bold text-white mb-2'>{{ task.title }}</h1>
                    <p class='text-blue-200'>Manage and review applications for this task.</p>
                </div>

                <!-- Quick Stats -->
                <div class='flex gap-4'>
                    <div
                        class='bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 text-center min-w-[100px]'>
                        <div class='text-2xl font-bold text-white'>{{ pending_count }}</div>
                        <div class='text-xs text-blue-200 uppercase tracking-wider'>Pending</div>
                    </div>
                    <div
                        class='bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 text-center min-w-[100px]'>
                        <div class='text-2xl font-bold text-emerald-400'>{{ accepted_applications|length }}</div>
                        <div class='text-xs text-blue-200 uppercase tracking-wider'>Accepted</div>
                    </div>
                    <div
                        class='bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 text-center min-w-[100px]'>
                        <div class='text-2xl font-bold text-white'>{{ total_count }}</div>
                        <div class='text-xs text-blue-200 uppercase tracking-wider'>Total</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class='max-w-7xl mx-auto px-6 -mt-20'>
        <div class='grid grid-cols-1 lg:grid-cols-3 gap-8'>

            <!-- Left Column: Applications List -->
            <div class='lg:col-span-2 space-y-8'>

                {% if pending_count == 0 and accepted_applications|length == 0 and rejected_applications|length == 0 %}
                <div class='bg-white rounded-2xl shadow-sm p-12 text-center' data-aos='fade-up'>
                    <div class='w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6'>
                        <i data-lucide='inbox' class='w-10 h-10 text-gray-400'></i>
                    </div>
                    <h3 class='text-xl font-bold text-gray-900 mb-2'>No Applications Yet</h3>
                    <p class='text-gray-500 max-w-md mx-auto'>Your task hasn't received any applications. We'll notify
                        you when someone applies.</p>
                </div>
                {% endif %}

                <!-- Pending Applications -->
                {% if pending_applications %}
                <div>
                    <div class='flex items-center justify-between mb-4'>
                        <h2 class='text-xl font-bold text-gray-800 flex items-center gap-2'>
                            <span class='w-3 h-3 rounded-full bg-yellow-400'></span> Pending Review
                        </h2>
                        <span class='text-sm text-gray-500'>Sorted by Match Score</span>
                    </div>

                    <div class='space-y-6'>
                        {% for app in pending_applications %}
                        <div class='bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden group'
                            data-aos='fade-up'>
                            <!-- Newbie Banner -->
                            {% if app.current_is_newbie %}
                            <div
                                class='bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-xs font-bold px-4 py-1 flex items-center justify-between'>
                                <span class='flex items-center gap-1'><i data-lucide='sparkles' class='w-3 h-3'></i> NEW
                                    DOER BOOST ACTIVE</span>
                                <span>+15.0 Bonus Points</span>
                            </div>
                            {% endif %}

                            <div class='p-6'>
                                <!-- Header: User & Score -->
                                <div class='flex justify-between items-start mb-6'>
                                    <div class='flex gap-4'>
                                        <div
                                            class='w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center text-2xl font-bold shadow-md'>
                                            {{ app.doer.fullname.0|upper }}
                                        </div>
                                        <div>
                                            <h3 class='text-lg font-bold text-gray-900'>{{ app.doer.fullname }}</h3>
                                            <p class='text-sm text-gray-500 mb-1'>Applied {{ app.created_at|timesince }}
                                                ago</p>
                                            <div class='flex gap-2'>
                                                {% for skill in app.validated_skills_display %}
                                                <span
                                                    class='inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700'>
                                                    {{ skill }}
                                                </span>
                                                {% empty %}
                                                <span class='text-xs text-gray-400 italic'>No verified skills</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Score Badge -->
                                    <div class='text-right'>
                                        <div class='inline-flex flex-col items-end'>
                                            <span
                                                class='text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1'>Match
                                                Score</span>
                                            <div class='flex items-baseline text-yellow-600'>
                                                <span class='text-3xl font-extrabold'>{{ app.calculated_ranking_score|floatformat:1 }}</span>
                                                <span class='text-sm text-yellow-600/60 ml-1'>/100</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Grid Stats -->
                                <div class='grid grid-cols-2 md:grid-cols-3 gap-4 mb-6'>
                                    <div class='bg-gray-50 rounded-xl p-3 border border-gray-100'>
                                        <div class='text-xs text-gray-500 mb-1'>Avg Rating</div>
                                        <div class='flex items-center gap-1 font-bold text-gray-900'>
                                            <i data-lucide='star' class='w-4 h-4 text-yellow-400 fill-yellow-400'></i>
                                            {% if app.current_rating > 0 %}{{ app.current_rating|floatformat:1 }}% {% else %}N/A{% endif %}
                                        </div>
                                    </div>
                                    <div class='bg-gray-50 rounded-xl p-3 border border-gray-100'>
                                        <div class='text-xs text-gray-500 mb-1'>Tasks Done</div>
                                        <div class='flex items-center gap-1 font-bold text-gray-900'>
                                            <i data-lucide='check-circle' class='w-4 h-4 text-green-500'></i>
                                            {{ app.current_completed }}
                                        </div>
                                    </div>
                                    <div
                                        class='bg-gray-50 rounded-xl p-3 border border-gray-100 col-span-2 md:col-span-1'>
                                        <div class='text-xs text-gray-500 mb-1'>Timeline</div>
                                        <div class='flex items-center gap-1 font-bold text-gray-900 truncate'>
                                            <i data-lucide='clock' class='w-4 h-4 text-blue-500'></i>
                                            {{ app.proposed_timeline|default:'Flexible' }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Cover Letter -->
                                <div class='mb-6 relative'>
                                    <i data-lucide='quote'
                                        class='absolute -top-2 -left-2 w-8 h-8 text-gray-100 -z-10'></i>
                                    <p class='text-gray-600 leading-relaxed italic pl-4 border-l-4 border-indigo-100'>
                                        &quot;{{ app.cover_letter }}&quot;</p>
                                </div>

                                <!-- Reputation Highlights -->
                                {% if app.highest_rating and app.lowest_rating %}
                                <div class='grid grid-cols-1 md:grid-cols-2 gap-4 mb-6'>
                                    <div class='bg-emerald-50/50 rounded-xl p-4 border border-emerald-100'>
                                        <div class='flex justify-between items-center mb-2'>
                                            <span class='text-xs font-bold text-emerald-700 uppercase'>Best
                                                Review</span>
                                            <span
                                                class='text-xs font-bold bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded'>{{ app.highest_rating.score }}/10</span>
                                        </div>
                                        <p class='text-xs text-emerald-900/70 italic'>&quot;{{ app.highest_rating.feedback|truncatewords:12 }}&quot;</p>
                                    </div>
                                    <div class='bg-rose-50/50 rounded-xl p-4 border border-rose-100'>
                                        <div class='flex justify-between items-center mb-2'>
                                            <span class='text-xs font-bold text-rose-700 uppercase'>Critical
                                                Review</span>
                                            <span
                                                class='text-xs font-bold bg-rose-100 text-rose-700 px-2 py-0.5 rounded'>{{ app.lowest_rating.score }}/10</span>
                                        </div>
                                        <p class='text-xs text-rose-900/70 italic'>&quot;{{ app.lowest_rating.feedback|truncatewords:12 }}&quot;</p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Actions -->
                                <div class='flex gap-3 pt-6 border-t border-gray-100'>
                                    <a href='{% url 'accept_application' app.id %}'
                                        onclick="return confirm('Accept this application? This will reject others.')"
                                        class='flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2'>
                                        <i data-lucide='check' class='w-4 h-4'></i> Accept Application
                                    </a>
                                    <a href='{% url 'reject_application' app.id %}'
                                        onclick="return confirm('Reject this application?')"
                                        class='px-4 py-3 text-red-600 hover:bg-red-50 font-semibold rounded-xl border border-transparent hover:border-red-100 transition-all flex items-center justify-center'>
                                        <i data-lucide='x' class='w-4 h-4'></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Accepted Applications -->
                {% if accepted_applications %}
                <div class='mt-12'>
                    <h2 class='text-xl font-bold text-emerald-800 mb-6 flex items-center gap-2'>
                        <i data-lucide='check-circle' class='w-5 h-5 text-emerald-500'></i> Accepted Candidate
                    </h2>
                    {% for app in accepted_applications %}
                    <div
                        class='bg-emerald-50 border border-emerald-100 rounded-2xl p-6 flex items-center justify-between shadow-sm'>
                        <div class='flex items-center gap-4'>
                            <div
                                class='w-14 h-14 bg-emerald-200 rounded-full flex items-center justify-center text-emerald-800 font-bold text-xl'>
                                {{ app.doer.fullname.0|upper }}</div>
                            <div>
                                <h3 class='font-bold text-emerald-900 text-lg'>{{ app.doer.fullname }}</h3>
                                <p class='text-emerald-700 text-sm'>Accepted {{ app.reviewed_at|timesince }} ago</p>
                            </div>
                        </div>
                        <span
                            class='bg-emerald-200 text-emerald-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide'>Hired</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Rejected Applications -->
                {% if rejected_applications %}
                <div class='mt-12 border-t pt-8'>
                    <details class='group'>
                        <summary class='flex items-center cursor-pointer text-gray-500 hover:text-gray-900 font-medium'>
                            <i data-lucide='chevron-right'
                                class='w-4 h-4 mr-2 transition-transform group-open:rotate-90'></i>
                            View Rejected Applications ({{ rejected_applications|length }})
                        </summary>
                        <div class='mt-4 space-y-3 pl-6'>
                            {% for app in rejected_applications %}
                            <div class='flex items-center justify-between p-3 bg-gray-100 rounded-lg opacity-60'>
                                <span class='font-medium text-gray-700'>{{ app.doer.fullname }}</span>
                                <span class='text-xs text-gray-500'>Rejected {{ app.reviewed_at|timesince }}
                                    ago</span>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                </div>
                {% endif %}

            </div>

            <!-- Right Column: Info & Filters -->
            <div class='lg:col-span-1'>
                <div class='sticky top-6 space-y-6'>
                    <!-- Task Summary Card -->
                    <div class='bg-white rounded-2xl shadow-sm border border-gray-100 p-6'>
                        <h3 class='font-bold text-gray-900 mb-4'>Task Details</h3>
                        <div class='space-y-4'>
                            <div>
                                <div class='text-xs text-gray-500 uppercase tracking-wider mb-1'>Status</div>
                                <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if task.status == ' open' %}bg-green-100 text-green-800 {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800 {% else %}bg-gray-100
                                    text-gray-800{% endif %}'>
                                    {{ task.get_status_display|upper }}
                                </span>
                            </div>
                            <div>
                                <div class='text-xs text-gray-500 uppercase tracking-wider mb-1'>Budget</div>
                                <div class='font-bold text-gray-900'>&#8369;{{ task.price|floatformat:2 }}</div>
                            </div>
                            <div>
                                <div class='text-xs text-gray-500 uppercase tracking-wider mb-1'>Category</div>
                                <div class='text-sm text-gray-700'>{{ task.get_category_display }}</div>
                            </div>
                        </div>
                        <div class='mt-6 pt-6 border-t border-gray-100'>
                            <a href='{% url 'edit_task' task.id %}'
                                class='block w-full text-center py-2 px-4 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors'>
                                Edit Task
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Additional custom styles if needed, mostly using Tailwind */
</style>
{% endblock %}