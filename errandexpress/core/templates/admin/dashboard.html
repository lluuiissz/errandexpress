{% extends 'admin/base_site.html' %}
{% block title %}Admin Dashboard - ErrandExpress{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-card">
        <div class="dashboard-header">
            <h1>üìä System Overview</h1>
            <p>Unified Operational Monitor</p>
        </div>

        <div class="dashboard-body">
            <!-- KPIS ROW -->
            <div class="kpi-row">
                <div class="kpi-item">
                    <span class="kpi-label">Users</span>
                    <span class="kpi-value">{{ total_users }}</span>
                    <span class="kpi-change">+{{ new_users_week }}</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-label">Tasks</span>
                    <span class="kpi-value">{{ total_tasks }}</span>
                    <span class="kpi-change">+{{ tasks_this_week }}</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-label">Revenue</span>
                    <span class="kpi-value">‚Ç±{{ total_revenue }}</span>
                    <span class="kpi-change">‚Ç±{{ revenue_this_month }}</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-label">Pending Skills</span>
                    <span class="kpi-value">{{ pending_skills }}</span>
                </div>
            </div>

            <hr class="divider">

            <!-- OPERATIONAL CARDS ROW (Restored Task Card) -->
            <div class="ops-grid">

                <!-- Task Management Card -->
                <div class="ops-card task-card">
                    <div class="ops-header">
                        <h3>üìã Task Health</h3>
                        <a href="{% url 'admin_tasks' %}" class="btn-sm">Manage</a>
                    </div>
                    <div class="ops-body">
                        <div class="stat-row">
                            <span>Open</span>
                            <strong>{{ open_tasks }}</strong>
                        </div>
                        <div class="stat-row">
                            <span>In Progress</span>
                            <strong>{{ in_progress_tasks }}</strong>
                        </div>
                        <div class="stat-row">
                            <span>Completed</span>
                            <strong>{{ completed_tasks }}</strong>
                        </div>
                        <div class="stat-row highlight">
                            <span>Success Rate</span>
                            <strong class="text-mint">{{ completion_rate }}%</strong>
                        </div>

                        {% if stalled_tasks_count > 0 %}
                        <div class="alert-mini warning">
                            ‚ö†Ô∏è <strong>{{ stalled_tasks_count }}</strong> stalled (>7 days)
                        </div>
                        {% else %}
                        <div class="alert-mini success">
                            ‚úÖ No stalled tasks
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- User Management Card -->
                <div class="ops-card user-card">
                    <div class="ops-header">
                        <h3>üë• User Status</h3>
                        <a href="{% url 'admin_users' %}" class="btn-sm">Manage</a>
                    </div>
                    <div class="ops-body">
                        <div class="stat-row">
                            <span>Task Posters</span>
                            <strong>{{ task_posters }}</strong>
                        </div>
                        <div class="stat-row">
                            <span>Task Doers</span>
                            <strong>{{ task_doers }}</strong>
                        </div>
                        <div class="stat-row">
                            <span>New (Week)</span>
                            <strong>{{ new_users_week }}</strong>
                        </div>
                        <div class="stat-row highlight">
                            <span>Total Users</span>
                            <strong>{{ total_users }}</strong>
                        </div>
                    </div>
                </div>

                <!-- Skill Validation Card -->
                <div class="ops-card skill-card">
                    <div class="ops-header">
                        <h3>üéì Verification</h3>
                        <a href="{% url 'admin_skill_validation' %}" class="btn-sm">Review</a>
                    </div>
                    <div class="ops-body">
                        <div class="stat-row">
                            <span>Verified</span>
                            <strong>{{ verified_skills }}</strong>
                        </div>
                        <div class="stat-row">
                            <span>Pending</span>
                            <strong class="text-orange">{{ pending_skills }}</strong>
                        </div>

                        {% if pending_skills > 0 %}
                        <div class="alert-mini warning">
                            üìù <strong>{{ pending_skills }}</strong> need review
                        </div>
                        {% else %}
                        <div class="alert-mini success">
                            ‚úÖ All clear
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>

            <hr class="divider">

            <!-- ANALYTICS GRID -->
            <h3 class="section-title">üìä Platform Analytics</h3>
            <div class="analytics-grid">
                <!-- Task Types -->
                <div class="analytics-col">
                    <h4>üìÇ Categories</h4>
                    <ul>
                        {% for category in category_stats %}
                        <li>
                            <span>{{ category.category|title }}</span>
                            <strong>{{ category.count }}</strong>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Locations -->
                <div class="analytics-col">
                    <h4>üìç Campus Scope</h4>
                    <ul>
                        {% for campus in campus_stats %}
                        <li>
                            <span>{{ campus.campus_location|title|default:"Off-Campus" }}</span>
                            <strong>{{ campus.count }}</strong>
                        </li>
                        {% empty %}
                        <li class="empty">No data</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Financials -->
                <div class="analytics-col">
                    <h4>üí∞ Commission Source</h4>
                    <ul>
                        {% for rev in revenue_by_category %}
                        <li>
                            <span>{{ rev.task__category|title }}</span>
                            <strong>‚Ç±{{ rev.total_revenue|floatformat:2 }}</strong>
                        </li>
                        {% empty %}
                        <li class="empty">No data</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Methods -->
                <div class="analytics-col">
                    <h4>üíµ Payment Methods</h4>
                    <ul>
                        {% for method in payment_method_stats %}
                        <li>
                            <span>{% if method.payment_method == 'cod' %}COD{% else %}Online{% endif %}</span>
                            <strong>{{ method.count }}</strong>
                        </li>
                        {% empty %}
                        <li class="empty">No data</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .admin-dashboard {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    /* Headers */
    .dashboard-header {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #eee;
        text-align: center;
    }

    .dashboard-header h1 {
        margin: 0;
        font-size: 1.5rem;
        color: #2d3748;
    }

    .dashboard-header p {
        margin: 0.25rem 0 0;
        color: #718096;
        font-size: 0.9rem;
    }

    .section-title {
        font-size: 1.1rem;
        color: #4a5568;
        margin-bottom: 1.5rem;
        border-left: 4px solid #667eea;
        padding-left: 1rem;
    }

    .dashboard-body {
        padding: 2rem;
    }

    /* KPI Row */
    .kpi-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        text-align: center;
        margin-bottom: 2rem;
    }

    .kpi-label {
        display: block;
        color: #718096;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .kpi-value {
        display: block;
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
    }

    .kpi-change {
        font-size: 0.85rem;
        color: #48bb78;
    }

    .divider {
        border: 0;
        border-top: 1px solid #edf2f7;
        margin: 3rem 0;
    }

    /* Ops Grid (Cards) */
    .ops-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }

    .ops-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        transition: transform 0.2s;
    }

    .ops-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .ops-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid #edf2f7;
        padding-bottom: 0.75rem;
    }

    .ops-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-sm {
        background: #ebf4ff;
        color: #5a67d8;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .btn-sm:hover {
        background: #c3dafe;
    }

    .ops-body .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        font-size: 0.95rem;
        color: #4a5568;
    }

    .ops-body .stat-row.highlight {
        background: #f7fafc;
        padding: 0.75rem 0.5rem;
        margin: 0.5rem -0.5rem;
        border-radius: 6px;
        font-weight: 600;
    }

    .alert-mini {
        padding: 0.75rem;
        border-radius: 6px;
        margin-top: 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .alert-mini.warning {
        background: #fffaf0;
        color: #c05621;
        border: 1px solid #fbd38d;
    }

    .alert-mini.success {
        background: #f0fff4;
        color: #2f855a;
        border: 1px solid #9ae6b4;
    }

    .text-mint {
        color: #38b2ac;
    }

    .text-orange {
        color: #dd6b20;
    }

    /* Task Card Specifics */
    .task-card {
        border-top: 4px solid #48bb78;
    }

    .user-card {
        border-top: 4px solid #667eea;
    }

    .skill-card {
        border-top: 4px solid #ed8936;
    }

    /* Analytics Grid */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
    }

    .analytics-col h4 {
        font-size: 0.95rem;
        text-transform: uppercase;
        color: #718096;
        margin-bottom: 1rem;
        letter-spacing: 0.5px;
    }

    .analytics-col ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .analytics-col li {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px dashed #edf2f7;
        font-size: 0.9rem;
    }

    .analytics-col strong {
        color: #2d3748;
    }

    .empty {
        color: #a0aec0;
        font-style: italic;
    }
</style>
{% endblock %}