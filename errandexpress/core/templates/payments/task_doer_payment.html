{% extends 'base_complete.html' %}

{% block title %}Pay Task Doer - ErrandExpress{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 py-12 px-4">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                <i data-lucide="credit-card" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Pay Task Doer</h1>
            <p class="text-lg text-gray-600">Complete payment to rate the task doer</p>
        </div>

        <!-- Payment Card -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <!-- Task Info -->
            <div class="mb-6 pb-6 border-b">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Task Details</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Task:</span>
                        <span class="font-bold text-gray-900">{{ task.title }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Task Doer:</span>
                        <span class="font-bold text-gray-900">{{ doer.fullname }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Payment Method:</span>
                        <span
                            class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                            Online Payment
                        </span>
                    </div>
                </div>
            </div>

            <!-- Amount Summary with Commission Breakdown -->
            <div class="mb-6 pb-6 border-b">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Summary</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Original Task Amount:</span>
                        <span class="font-bold text-gray-900">₱{{ original_price }}</span>
                    </div>

                    {% if commission_deducted %}
                    <div class="flex justify-between items-center text-red-600">
                        <span class="flex items-center gap-1">
                            <i data-lucide="minus-circle" class="w-4 h-4"></i>
                            System Commission (10%):
                        </span>
                        <span class="font-bold">-₱{{ commission_amount }}</span>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-900">
                        <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                        Commission was auto-deducted after 5 free messages
                    </div>
                    {% endif %}

                    <div class="flex justify-between items-center text-lg border-t pt-3">
                        <span class="font-bold text-gray-900">Amount to Pay Doer:</span>
                        <span class="text-2xl font-bold text-blue-600">₱{{ amount }}</span>
                    </div>

                    {% if not commission_deducted %}
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-900">
                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                        Note: Full amount will be paid (commission not yet deducted)
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Information Form -->
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Information</h2>

                <form method="POST" class="space-y-4">
                    {% csrf_token %}

                    <!-- Full Name -->
                    <div>
                        <label class="block text-sm font-bold text-gray-900 mb-2">Full Name *</label>
                        <input type="text" name="fullname" value="{{ fullname }}" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="Your full name">
                    </div>

                    <!-- Phone -->
                    <div>
                        <label class="block text-sm font-bold text-gray-900 mb-2">Phone Number *</label>
                        <input type="tel" name="phone" value="{{ phone }}" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="09XXXXXXXXX">
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-bold text-gray-900 mb-2">Email Address *</label>
                        <input type="email" name="email" value="{{ email }}" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="your@email.com">
                    </div>

                    <!-- Payment Methods -->
                    <div class="pt-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">Select Payment Method</h3>

                        {% for method in payment_methods %}
                        <label
                            class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition mb-3">
                            <input type="radio" name="payment_method" value="{{ method.value }}" {% if forloop.first
                                %}checked{% endif %} class="w-4 h-4 text-blue-600">
                            <div class="ml-4 flex-grow">
                                <div class="font-bold text-gray-900">{{ method.name }}</div>
                                <div class="text-sm text-gray-600">
                                    {% if method.value == 'gcash' %}
                                    Pay via GCash - Fast and secure
                                    {% elif method.value == 'card' %}
                                    Pay via Credit/Debit Card
                                    {% endif %}
                                </div>
                            </div>
                            <span class="text-2xl">{{ method.icon }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <!-- GCash Number (conditional) -->
                    <div id="gcash-number-field" class="hidden">
                        <label class="block text-sm font-bold text-gray-900 mb-2">GCash Number (Optional)</label>
                        <input type="text" name="gcash_number" value="{{ gcash_number }}"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="09XXXXXXXXX">
                    </div>

                    <!-- Submit Button -->
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2 mt-6">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        Proceed to Payment
                    </button>
                </form>
            </div>

            <!-- Info Box -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm text-blue-900">
                            After completing this payment, you'll be able to rate the task doer and regain full system
                            access.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Link -->
        <div class="text-center">
            <a href="{% url 'task_detail' task.id %}"
                class="text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center gap-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to Task
            </a>
        </div>
    </div>
</div>

<script>
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }

    // Show/hide GCash number field based on payment method
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const gcashField = document.getElementById('gcash-number-field');
            if (this.value === 'gcash') {
                gcashField.classList.remove('hidden');
            } else {
                gcashField.classList.add('hidden');
            }
        });
    });

    // Initialize on page load
    const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
    if (selectedMethod && selectedMethod.value === 'gcash') {
        document.getElementById('gcash-number-field').classList.remove('hidden');
    }
</script>
{% endblock %}