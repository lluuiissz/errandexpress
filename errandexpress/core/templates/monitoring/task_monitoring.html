{% extends "base_complete.html" %}
{% load static %}

{% block title %}Task Monitoring - ErrandExpress{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">üìä Task Monitoring</h1>
        <p class="text-gray-600">
            {% if role == 'poster' %}
            Track and manage your posted tasks
            {% else %}
            Monitor your assigned tasks and provide feedback
            {% endif %}
        </p>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8">
        <!-- Total Tasks -->
        <div
            class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl md:rounded-2xl p-4 md:p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <i data-lucide="list" class="w-5 md:w-6 h-5 md:h-6 opacity-80"></i>
                <span class="text-xs opacity-80 font-medium">Total</span>
            </div>
            <div class="text-2xl md:text-3xl font-bold">{{ stats.total }}</div>
        </div>

        <!-- Completed -->
        <div
            class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl md:rounded-2xl p-4 md:p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <i data-lucide="check-circle" class="w-5 md:w-6 h-5 md:h-6 opacity-80"></i>
                <span class="text-xs opacity-80 font-medium">Completed</span>
            </div>
            <div class="text-2xl md:text-3xl font-bold">{{ stats.completed }}</div>
        </div>

        <!-- In Progress -->
        <div
            class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl md:rounded-2xl p-4 md:p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <i data-lucide="clock" class="w-5 md:w-6 h-5 md:h-6 opacity-80"></i>
                <span class="text-xs opacity-80 font-medium">In Progress</span>
            </div>
            <div class="text-2xl md:text-3xl font-bold">{{ stats.in_progress }}</div>
        </div>

        <!-- Completion Rate -->
        <div
            class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl md:rounded-2xl p-4 md:p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <i data-lucide="trending-up" class="w-5 md:w-6 h-5 md:h-6 opacity-80"></i>
                <span class="text-xs opacity-80 font-medium">Rate</span>
            </div>
            <div class="text-2xl md:text-3xl font-bold">{{ stats.completion_rate|floatformat:0 }}%</div>
        </div>
    </div>

    <!-- Tasks Table -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <i data-lucide="list-checks" class="w-5 h-5 text-blue-600"></i>
                Tasks
            </h2>
        </div>

        {% if tasks %}
        <!-- Desktop Table View -->
        <div class="overflow-x-auto hidden md:block">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Task</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">
                            {% if role == 'poster' %}Doer{% else %}Poster{% endif %}
                        </th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Price</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Deadline</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                        <!-- Task Title -->
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">{{ task.title }}</div>
                            <div class="text-sm text-gray-500">{{ task.category|upper }}</div>
                        </td>

                        <!-- Doer/Poster Name -->
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold">
                                    {% if role == 'poster' %}
                                    {{ task.doer.fullname|first|upper }}
                                    {% else %}
                                    {{ task.poster.fullname|first|upper }}
                                    {% endif %}
                                </div>
                                <span class="text-sm text-gray-700">
                                    {% if role == 'poster' %}
                                    {{ task.doer.fullname|default:"Unassigned" }}
                                    {% else %}
                                    {{ task.poster.fullname }}
                                    {% endif %}
                                </span>
                            </div>
                        </td>

                        <!-- Status Badge -->
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium
                                {% if task.status == 'completed' %}bg-green-100 text-green-700
                                {% elif task.status == 'in_progress' %}bg-yellow-100 text-yellow-700
                                {% elif task.status == 'open' %}bg-blue-100 text-blue-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                <i data-lucide="{% if task.status == 'completed' %}check-circle{% elif task.status == 'in_progress' %}clock{% else %}alert-circle{% endif %}"
                                    class="w-3 h-3"></i>
                                {{ task.get_status_display }}
                            </span>
                        </td>

                        <!-- Price -->
                        <td class="px-6 py-4">
                            <span class="font-medium text-gray-900">‚Ç±{{ task.price }}</span>
                        </td>

                        <!-- Deadline -->
                        <td class="px-6 py-4">
                            <span class="text-sm text-gray-600">{{ task.deadline|date:"M d, Y" }}</span>
                        </td>

                        <!-- Actions -->
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <a href="{% url 'task_detail' task.id %}"
                                    class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    View
                                </a>
                                {% if task.status == 'completed' %}
                                    {% if task.user_has_rated %}
                                    <span class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-green-700 bg-green-50 rounded-lg">
                                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                                        Rated
                                    </span>
                                    {% else %}
                                    <a href="{% url 'rate_user' task.id task.doer.id %}"
                                        class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-amber-600 hover:bg-amber-50 rounded-lg transition-colors">
                                        <i data-lucide="star" class="w-4 h-4"></i>
                                        Pay & Rate
                                    </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden space-y-4 p-4">
            {% for task in tasks %}
            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                <!-- Task Title -->
                <div class="mb-3">
                    <h3 class="font-semibold text-gray-900">{{ task.title }}</h3>
                    <p class="text-xs text-gray-500 mt-1">{{ task.category|upper }}</p>
                </div>

                <!-- Task Info Grid -->
                <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                    <div>
                        <p class="text-gray-500 text-xs">{% if role == 'poster' %}Doer{% else %}Poster{% endif %}</p>
                        <p class="font-medium text-gray-900">
                            {% if role == 'poster' %}
                            {{ task.doer.fullname|default:"Unassigned" }}
                            {% else %}
                            {{ task.poster.fullname }}
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs">Status</p>
                        <p class="font-medium">
                            {% if task.status == 'open' %}
                            <span
                                class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">Open</span>
                            {% elif task.status == 'in_progress' %}
                            <span
                                class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold">In
                                Progress</span>
                            {% elif task.status == 'completed' %}
                            <span
                                class="inline-block px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">Completed</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>

                        <p class="text-gray-500 text-xs">Price</p>

                        <p class="font-medium text-gray-900">‚Ç±{{ task.price }}</p>

                    </div>

                    <div>

                        <p class="text-gray-500 text-xs">Deadline</p>

                        <p class="font-medium text-gray-900">{{ task.deadline|date:"M d, Y" }}</p>

                    </div>

                </div>



                <!-- Actions -->

                <div class="flex gap-2">

                    <a href="{% url 'task_detail' task.id %}"

                        class="flex-1 text-center px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">

                        View

                    </a>

                    {% if task.status == 'completed' %}

                    <a href="{% url 'rate_user' task.id task.doer.id %}"

                        class="flex-1 text-center px-3 py-2 text-sm font-medium text-amber-600 bg-amber-50 hover:bg-amber-100 rounded-lg transition-colors">

                        Pay & Rate

                    </a>

                    {% endif %}

                </div>

            </div>

            {% endfor %}

        </div>



        {% else %}

        <!-- Empty State -->

        <div class="p-12 text-center">

            <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">

                <i data-lucide="inbox" class="w-10 h-10 text-gray-400"></i>

            </div>

            <h3 class="text-lg font-semibold text-gray-900 mb-2">No tasks yet</h3>

            <p class="text-gray-600">

                {% if role == 'poster' %}

                You haven't posted any tasks yet

                {% else %}

                You haven't been assigned any tasks yet

                {% endif %}

            </p>

        </div>

        {% endif %}

    </div>

</div>



<!-- Feedback Modal -->

<div id="feedback-modal"

    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">

        <div class="flex items-center justify-between mb-6">

            <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">

                <i data-lucide="star" class="w-6 h-6 text-yellow-500"></i>

                Rate Task

            </h3>

            <button onclick="closeFeedbackModal()"

                class="text-gray-400 hover:text-gray-600 transition-colors">

                <i data-lucide="x" class="w-6 h-6"></i>

            </button>

        </div>



        <div id="task-info" class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">

            <div class="text-xs text-blue-600 font-medium mb-1">Task</div>

            <div id="task-title" class="font-semibold text-gray-900"></div>

        </div>



        <!-- Rating Scale -->

        <div class="mb-6">

            <label class="block text-sm font-semibold text-gray-700 mb-4">Select Rating (1-10)</label>

            <div class="flex gap-2 justify-center flex-wrap">

                {% for i in "1234567890" %}

                <button onclick="setRating({{ forloop.counter }})"

                    class="rating-btn w-10 h-10 rounded-lg border-2 border-gray-200 hover:border-yellow-400 hover:bg-yellow-50 transition-all font-semibold text-gray-700 text-sm"

                    data-rating="{{ forloop.counter }}">

                    {{ forloop.counter }}

                </button>

                {% endfor %}

            </div>

            <div id="rating-display" class="text-center mt-4 text-2xl font-bold text-yellow-600 hidden">

                <span id="selected-rating">0</span>/10 ‚≠ê

            </div>

        </div>



        <!-- Feedback Text -->

        <div class="mb-6">

            <label class="block text-sm font-semibold text-gray-700 mb-2">Feedback (Optional)</label>

            <textarea id="feedback-text" placeholder="Share your experience..."

                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none resize-none text-sm"

                rows="3"></textarea>

        </div>



        <!-- Actions -->

        <div class="flex gap-3">

            <button onclick="closeFeedbackModal()"

                class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm">

                Cancel

            </button>

            <button onclick="submitFeedback()" id="submit-feedback-btn" disabled

                class="flex-1 px-4 py-2.5 bg-gradient-to-r from-yellow-500 to-amber-500 text-white rounded-lg hover:from-yellow-600 hover:to-amber-600 transition-all font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed">

                Submit

            </button>

        </div>

    </div>

</div>



{% endblock %}


            {% block extra_scripts %}
            <script>
                let selectedTaskId = null;
                let selectedRating = 0;

                function openFeedbackModal(taskId, taskTitle) {
                    selectedTaskId = taskId;
                    selectedRating = 0;
                    document.getElementById('task-title').textContent = taskTitle;
                    document.getElementById('feedback-text').value = '';
                    document.getElementById('rating-display').classList.add('hidden');
                    document.getElementById('submit-feedback-btn').disabled = true;
                    document.querySelectorAll('.rating-btn').forEach(btn => {
                        btn.classList.remove('bg-yellow-100', 'border-yellow-400');
                    });
                    document.getElementById('feedback-modal').classList.remove('hidden');
                }

                function closeFeedbackModal() {
                    document.getElementById('feedback-modal').classList.add('hidden');
                    selectedTaskId = null;
                    selectedRating = 0;
                }

                function setRating(rating) {
                    selectedRating = rating;
                    document.getElementById('selected-rating').textContent = rating;
                    document.getElementById('rating-display').classList.remove('hidden');
                    document.getElementById('submit-feedback-btn').disabled = false;

                    document.querySelectorAll('.rating-btn').forEach(btn => {
                        btn.classList.remove('bg-yellow-100', 'border-yellow-400');
                    });
                    document.querySelector(`[data-rating="${rating}"]`).classList.add('bg-yellow-100', 'border-yellow-400');
                }

                async function submitFeedback() {
                    if (!selectedRating || !selectedTaskId) {
                        alert('Please select a rating');
                        return;
                    }

                    const feedback = document.getElementById('feedback-text').value;
                    const btn = document.getElementById('submit-feedback-btn');
                    btn.disabled = true;
                    btn.textContent = 'Submitting...';

                    try {
                        const response = await fetch(`/api/submit-feedback/${selectedTaskId}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                            },
                            body: JSON.stringify({
                                score: selectedRating,
                                feedback: feedback
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert('Rating submitted successfully!');
                            closeFeedbackModal();
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to submit rating');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'Submit Rating';
                    }
                }

                document.addEventListener('DOMContentLoaded', function () {
                    const modal = document.getElementById('feedback-modal');
                    if (modal) {
                        modal.addEventListener('click', function (e) {
                            if (e.target === this) {
                                closeFeedbackModal();
                            }
                        });
                    }

                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
            </script>
            {% endblock %}