{% extends "base_complete.html" %}
{% load static %}

{% block title %}Browse Tasks - ErrandExpress{% endblock %}

{% block extra_css %}
<style>
    .filter-card {
        @apply bg-white rounded-2xl p-6 shadow-card sticky top-20;
    }

    .task-card {
        @apply bg-white rounded-2xl p-6 shadow-card hover:shadow-card-hover transition-all duration-200 border border-gray-100;
    }

    .task-card:hover {
        @apply transform -translate-y-1 scale-[1.01];
    }

    .price-tag {
        @apply text-2xl font-bold text-primary;
    }

    .urgent-glow {
        @apply ring-2 ring-red-200 bg-red-50/30;
    }

    .featured-glow {
        @apply ring-2 ring-blue-200 bg-blue-50/30;
    }

    .new-badge {
        @apply inline-flex items-center gap-1 px-2.5 py-1 bg-gradient-to-r from-emerald-500 to-green-500 text-white text-xs font-bold rounded-full shadow-sm;
        animation: pulse-subtle 2s ease-in-out infinite;
    }

    @keyframes pulse-subtle {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.85;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-bg">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white sticky top-16 z-30 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-8">
                <div>
                    <h1 class="text-4xl font-bold font-poppins">Available Tasks</h1>
                    <p class="text-blue-100 mt-2">{{ total_tasks }} opportunities matched to your skills</p>
                </div>

                <div class="flex items-center gap-3">
                    <button
                        class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors flex items-center gap-2 shadow-lg"
                        onclick="toggleFilters()">
                        <i data-lucide="filter" class="w-5 h-5"></i>
                        Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

            <!-- Filters Sidebar -->
            <div class="lg:col-span-1" id="filters-sidebar">
                <div class="filter-card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <i data-lucide="sliders-horizontal" class="w-5 h-5 text-primary"></i>
                            Filters
                        </h3>
                        <button onclick="clearFilters()" class="text-sm text-primary hover:underline">Clear All</button>
                    </div>

                    <form method="GET" class="space-y-5">
                        <!-- Search -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i>
                                Search Tasks
                            </label>
                            <input type="text" name="search" value="{{ filter_form.search.value|default:'' }}"
                                placeholder="Type to search..."
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                        </div>

                        <!-- Category -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <i data-lucide="folder" class="w-4 h-4"></i>
                                Category
                            </label>
                            <select name="category"
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white">
                                <option value="">All Categories</option>
                                <option value="typing" {% if filter_form.category.value == 'typing' %}selected {% endif %}>
                                    ‚å®Ô∏è Typing</option>
                                <option value="powerpoint" {% if filter_form.category.value == 'powerpoint' %}selected {% endif %}>üìä PowerPoint</option>
                                <option value="graphics" {% if filter_form.category.value == 'graphics' %}selected {% endif %}>üé® Graphics</option>
                                <option value="research" {% if filter_form.category.value == 'research' %}selected {% endif %}>üìö Research</option>
                                <option value="other" {% if filter_form.category.value == 'other' %}selected {% endif %}>üìå
                                    Other</option>
                            </select>
                        </div>

                        <!-- Price Range -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <i data-lucide="peso-sign" class="w-4 h-4"></i>
                                Price Range
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <input type="number" name="min_price"
                                        value="{{ filter_form.min_price.value|default:'' }}" placeholder="Min"
                                        class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                                    <span class="text-xs text-gray-500 mt-1 block">Minimum ‚Ç±</span>
                                </div>
                                <div>
                                    <input type="number" name="max_price"
                                        value="{{ filter_form.max_price.value|default:'' }}" placeholder="Max"
                                        class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                                    <span class="text-xs text-gray-500 mt-1 block">Maximum ‚Ç±</span>
                                </div>
                            </div>
                        </div>

                        <!-- Sort By -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                <i data-lucide="arrow-up-down" class="w-4 h-4"></i>
                                Sort By
                            </label>
                            <select name="sort_by"
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white">
                                <option value="-created_at" {% if filter_form.sort_by.value == '-created_at' %}selected {% endif %}>üÜï Newest First</option>
                                <option value="price" {% if filter_form.sort_by.value == 'price' %}selected {% endif %}>üí∞
                                    Price: Low ‚Üí High</option>
                                <option value="-price" {% if filter_form.sort_by.value == '-price' %}selected {% endif %}>
                                    üíé Price: High ‚Üí Low</option>
                                <option value="deadline" {% if filter_form.sort_by.value == 'deadline' %}selected {% endif %}>‚è∞ Deadline: Soonest</option>
                            </select>
                        </div>

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                            <i data-lucide="filter" class="w-5 h-5"></i>
                            Apply Filters
                        </button>
                    </form>

                    <!-- Quick Filters -->
                    <div class="mt-6 pt-6 border-t-2 border-gray-100">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
                            Quick Filters
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button
                                class="flex flex-col items-center justify-center p-3 rounded-lg border-2 border-gray-200 hover:border-red-500 hover:bg-red-50 transition-all text-center">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mb-1"></i>
                                <span class="text-xs font-medium text-gray-700">Urgent</span>
                            </button>
                            <button
                                class="flex flex-col items-center justify-center p-3 rounded-lg border-2 border-gray-200 hover:border-green-500 hover:bg-green-50 transition-all text-center">
                                <i data-lucide="dollar-sign" class="w-5 h-5 text-green-500 mb-1"></i>
                                <span class="text-xs font-medium text-gray-700">High Pay</span>
                            </button>
                            <button
                                class="flex flex-col items-center justify-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-center">
                                <i data-lucide="clock" class="w-5 h-5 text-blue-500 mb-1"></i>
                                <span class="text-xs font-medium text-gray-700">Quick</span>
                            </button>
                            <button
                                class="flex flex-col items-center justify-center p-3 rounded-lg border-2 border-gray-200 hover:border-purple-500 hover:bg-purple-50 transition-all text-center">
                                <i data-lucide="map-pin" class="w-5 h-5 text-purple-500 mb-1"></i>
                                <span class="text-xs font-medium text-gray-700">Nearby</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Grid -->
            <div class="lg:col-span-3">
                <!-- Results Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Available Tasks</h2>
                        <p class="text-sm text-muted">{{ tasks|length }} of {{ total_tasks }} tasks</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn-icon" onclick="toggleView('grid')" id="grid-view">
                            <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-icon" onclick="toggleView('list')" id="list-view">
                            <i data-lucide="list" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Tasks List -->
                <div class="space-y-6" id="tasks-container">
                    {% for task in tasks %}
                    <div class="task-card {% if task.price >= 300 %}featured-glow{% elif task.deadline|timeuntil < '2 days' %}urgent-glow{% endif %}"
                        data-task-id="{{ task.id }}">

                        <!-- Task Header -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <h3 class="text-lg font-semibold text-gray-900 hover:text-primary cursor-pointer">
                                        {{ task.title }}
                                    </h3>
                                    {% if task.is_new %}
                                    <span class="new-badge">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i>
                                        NEW
                                    </span>
                                    {% endif %}
                                    {% if task.price >= 300 %}
                                    <span class="badge-primary">Featured</span>
                                    {% endif %}
                                    {% if task.deadline|timeuntil < '2 days' %} <span class="badge-danger">Urgent</span>
                                        {% endif %}
                                </div>

                                <div class="flex items-center gap-4 text-sm text-muted">
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        {{ task.poster.fullname }}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        {{ task.created_at|timesince }} ago
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="clock" class="w-4 h-4"></i>
                                        Due {{ task.deadline|date:"M d" }}
                                    </span>
                                </div>
                            </div>

                            <div class="text-right">
                                <div class="price-tag">‚Ç±{{ task.price }}</div>
                                <div class="text-xs text-muted">{{ task.payment_method|upper }}</div>
                            </div>
                        </div>

                        <!-- Task Content -->
                        <div class="mb-4">
                            <p class="text-gray-700 mb-3">{{ task.description|truncatewords:30 }}</p>

                            <div class="flex items-center gap-2 mb-3">
                                <span class="badge-primary">{{ task.category|title }}</span>
                                <span class="badge-mint">{{ task.doer_type|title }}</span>
                                {% if task.tags %}
                                <span class="badge badge-gray">{{ task.tags }}</span>
                                {% endif %}
                            </div>

                            <!-- Requirements Preview -->
                            {% if task.requirements %}
                            <div class="bg-gray-50 rounded-lg p-3 mb-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-1">Requirements:</h4>
                                <p class="text-sm text-gray-600">{{ task.requirements|truncatewords:20 }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Task Actions -->
                        <div class="flex items-center justify-between pt-6 border-t-2 border-gray-100 gap-3">
                            <button
                                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 text-lg"
                                onclick="applyToTask('{{ task.id }}')">
                                <i data-lucide="send" class="w-5 h-5"></i>
                                Apply Now
                            </button>
                            <button
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2"
                                onclick="viewTaskDetail('{{ task.id }}')">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                                Details
                            </button>
                            <button
                                class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition-colors"
                                onclick="saveTask('{{ task.id }}')" title="Save task">
                                <i data-lucide="bookmark" class="w-5 h-5"></i>
                            </button>
                            <button
                                class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition-colors"
                                onclick="shareTask('{{ task.id }}')" title="Share task">
                                <i data-lucide="share-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-12">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="search-x" class="w-12 h-12 text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
                        <p class="text-muted mb-4">Try adjusting your filters or check back later for new opportunities.
                        </p>
                        <button class="btn-primary" onclick="clearFilters()">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Clear Filters
                        </button>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if tasks.has_other_pages %}
                <div class="flex items-center justify-center mt-8">
                    <nav class="flex items-center gap-2">
                        {% if tasks.has_previous %}
                        <a href="?page={{ tasks.previous_page_number }}" class="btn-ghost">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            Previous
                        </a>
                        {% endif %}

                        <div class="flex items-center gap-1">
                            {% for num in tasks.paginator.page_range %}
                            {% if num == tasks.number %}
                            <span class="px-3 py-2 bg-primary text-white rounded-lg text-sm font-medium">{{ num
                                }}</span>
                            {% else %}
                            <a href="?page={{ num }}"
                                class="px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg text-sm">{{ num }}</a>
                            {% endif %}
                            {% endfor %}
                        </div>

                        {% if tasks.has_next %}
                        <a href="?page={{ tasks.next_page_number }}" class="btn-ghost">
                            Next
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Task Application Modal -->
<div id="application-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-primary">Apply to Task</h3>
                <button onclick="closeApplicationModal()" class="btn-icon">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <form id="application-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cover Message</label>
                    <textarea class="input-field h-24"
                        placeholder="Why are you the perfect fit for this task?"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Completion Time</label>
                    <select class="input-field">
                        <option>Within 24 hours</option>
                        <option>1-2 days</option>
                        <option>3-5 days</option>
                        <option>1 week</option>
                    </select>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="closeApplicationModal()" class="btn-ghost flex-1">Cancel</button>
                    <button type="submit" class="btn-primary flex-1">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }

    // DEBUG: Verify template version
    console.log('‚úÖ Browse Tasks Template - Version 2.0 (Functions Fixed)');

    // Global variables
    let currentTaskId = null;

    // Make functions globally accessible
    window.toggleFilters = function () {
        const sidebar = document.getElementById('filters-sidebar');
        sidebar.classList.toggle('hidden');
    }

    window.toggleView = function (viewType) {
        const container = document.getElementById('tasks-container');
        const gridBtn = document.getElementById('grid-view');
        const listBtn = document.getElementById('list-view');

        if (viewType === 'grid') {
            container.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
            gridBtn.classList.add('bg-primary', 'text-white');
            listBtn.classList.remove('bg-primary', 'text-white');
        } else {
            container.className = 'space-y-6';
            listBtn.classList.add('bg-primary', 'text-white');
            gridBtn.classList.remove('bg-primary', 'text-white');
        }
    }

    window.applyToTask = function (taskId) {
        currentTaskId = taskId;
        document.getElementById('application-modal').classList.remove('hidden');
    }

    window.closeApplicationModal = function () {
        document.getElementById('application-modal').classList.add('hidden');
        currentTaskId = null;
    }

    window.viewTaskDetail = function (taskId) {
        window.location.href = `/tasks/${taskId}/`;
    }

    window.saveTask = function (taskId) {
        // Toggle bookmark
        const btn = event.target.closest('button');
        const icon = btn.querySelector('i');

        if (icon.getAttribute('data-lucide') === 'bookmark') {
            icon.setAttribute('data-lucide', 'bookmark-check');
            btn.classList.add('text-primary');
            window.showToast('Task saved to bookmarks', 'success');
        } else {
            icon.setAttribute('data-lucide', 'bookmark');
            btn.classList.remove('text-primary');
            window.showToast('Task removed from bookmarks', 'info');
        }
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }

    window.shareTask = function (taskId) {
        const url = `${window.location.origin}/tasks/${taskId}/`;
        navigator.clipboard.writeText(url).then(() => {
            window.showToast('Task link copied to clipboard!', 'success');
        });
    }

    window.showToast = function (message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg transform transition-all duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
        toast.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="${type === 'success' ? 'check-circle' : 'info'}" class="w-5 h-5"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;

        document.body.appendChild(toast);
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }

        setTimeout(() => toast.classList.add('translate-y-0'), 10);
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    window.clearFilters = function () {
        window.location.href = window.location.pathname;
    }

    // Application form submission
    document.getElementById('application-form').addEventListener('submit', function (e) {
        e.preventDefault();

        if (!currentTaskId) return;

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Submitting...';
        submitBtn.disabled = true;

        // Redirect to apply task endpoint
        window.location.href = `/tasks/${currentTaskId}/apply/`;
    });

    // Real-time task updates
    setInterval(() => {
        // Check for new tasks
        updateTaskFeed();
    }, 60000);

    function updateTaskFeed() {
        fetch('/api/tasks/updates/')
            .then(response => response.json())
            .then(data => {
                if (data.new_tasks > 0) {
                    showToast(`${data.new_tasks} new tasks available!`, 'info');
                }
            })
            .catch(error => console.log('Update check failed:', error));
    }

    // DEBUG: Verify all functions are globally accessible
    console.log('üîß Function Check:', {
        applyToTask: typeof window.applyToTask,
        viewTaskDetail: typeof window.viewTaskDetail,
        saveTask: typeof window.saveTask,
        shareTask: typeof window.shareTask,
        toggleFilters: typeof window.toggleFilters,
        toggleView: typeof window.toggleView,
        closeApplicationModal: typeof window.closeApplicationModal,
        clearFilters: typeof window.clearFilters
    });
</script>
{% endblock %}