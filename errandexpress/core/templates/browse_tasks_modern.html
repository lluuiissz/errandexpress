{% extends "base_complete.html" %}
{% load static %}

{% block title %}Browse Tasks - ErrandExpress{% endblock %}

{% block extra_css %}
<style>
    /* Custom Scrollbar for sidebar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 8px;
        border: 2px solid #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
    }

    /* Glassmorphism Card */
    .task-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: rgba(99, 102, 241, 0.2);
    }

    /* Hero Pattern */
    .hero-pattern {
        background-image: radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.15) 1px, transparent 0);
        background-size: 24px 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50">

    <!-- Premium Hero Section -->
    <div
        class="relative bg-gradient-to-br from-indigo-900 via-blue-800 to-indigo-900 text-white overflow-hidden pb-12 pt-8">
        <div class="absolute inset-0 hero-pattern opacity-30"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-slate-50/10 to-transparent"></div>

        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="space-y-4">
                    <div
                        class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/20 backdrop-blur-sm">
                        <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                        <span class="text-xs font-semibold tracking-wide uppercase text-blue-100">Live Tasks Feed</span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-white leading-tight">
                        Find Your Next <br />
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-indigo-200">Errand
                            to Conquer</span>
                    </h1>
                    <p class="text-lg text-blue-100 max-w-xl leading-relaxed">
                        Discover {{ total_tasks }} opportunities matched to your skills. Earn money by helping others in
                        your campus community.
                    </p>
                </div>

                <!-- Quick Search Blobs -->
                <div class="hidden md:block relative">
                    <!-- Decor -->
                    <div
                        class="absolute -top-12 -right-12 w-64 h-64 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob">
                    </div>
                    <div
                        class="absolute -bottom-12 -left-12 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8 relative z-10 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

            <!-- Sidebar Filters (Sticky) -->
            <div class="lg:col-span-1 space-y-6">
                <div
                    class="bg-white rounded-2xl shadow-xl shadow-indigo-100/50 border border-indigo-50/50 sticky top-24 overflow-hidden">

                    <!-- Sidebar Header -->
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i data-lucide="sliders-horizontal" class="w-4 h-4 text-indigo-600"></i>
                            Filters
                        </h3>
                        <a href="{% url 'browse_tasks' %}"
                            class="text-xs font-medium text-indigo-600 hover:text-indigo-700 hover:underline">
                            Reset
                        </a>
                    </div>

                    <!-- Filter Form -->
                    <form method="GET" class="p-5 space-y-6">

                        <!-- Search Input -->
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                            </div>
                            <input type="text" name="search" value="{{ filter_form.search.value|default:'' }}"
                                class="w-full pl-10 pr-4 py-2.5 text-sm bg-gray-50 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-gray-400"
                                placeholder="Search keyword...">
                        </div>

                        <hr class="border-gray-100">

                        <!-- Categories -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Category</label>
                            <select name="category"
                                class="w-full px-3 py-2 text-sm bg-gray-50 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                                <option value="">All Categories</option>
                                {% for value, label in filter_form.fields.category.choices %}
                                <option value="{{ value }}" {% if filter_form.category.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Price Range -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Budget (₱)</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <input type="number" name="min_price"
                                        value="{{ filter_form.min_price.value|default:'' }}"
                                        class="w-full px-3 py-2 text-sm bg-gray-50 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                        placeholder="Min">
                                </div>
                                <div>
                                    <input type="number" name="max_price"
                                        value="{{ filter_form.max_price.value|default:'' }}"
                                        class="w-full px-3 py-2 text-sm bg-gray-50 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
                                        placeholder="Max">
                                </div>
                            </div>
                        </div>

                        <!-- Sorting -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Sort By</label>
                            <select name="sort_by" onchange="this.form.submit()"
                                class="w-full px-3 py-2 text-sm bg-gray-50 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500">
                                {% for value, label in filter_form.fields.sort_by.choices %}
                                <option value="{{ value }}" {% if filter_form.sort_by.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit"
                            class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2">
                            Apply Filters
                        </button>
                    </form>
                </div>
            </div>

            <!-- Task Grid -->
            <div class="lg:col-span-3 space-y-6">

                <!-- Match Info Alert -->
                {% if user_skills %}
                <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4 flex items-start gap-3">
                    <div class="bg-indigo-100 p-2 rounded-lg shrink-0">
                        <i data-lucide="sparkles" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-indigo-900">Customized For You</h4>
                        <p class="text-sm text-indigo-700 mt-1">
                            Showing tasks matching your skills:
                            {% for skill in user_skills %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 ml-1">{{ skill }}</span>
                            {% endfor %}
                        </p>
                    </div>
                </div>
                {% endif %}

                {% if tasks %}
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {% for task in tasks %}
                    <div class="task-card flex flex-col h-full rounded-2xl p-5 relative group overflow-hidden">

                        <!-- Top Badges -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span
                                    class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600 uppercase tracking-wide">
                                    {{ task.get_category_display }}
                                </span>

                                <!-- Priority Badge (NEW) -->
                                {% if task.priority_level %}
                                {% if task.priority_level == 5 %}
                                <span
                                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-red-500 text-white shadow-sm">
                                    <i data-lucide="zap" class="w-3 h-3"></i>⭐⭐⭐⭐⭐
                                </span>
                                {% elif task.priority_level == 4 %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-500 text-white shadow-sm">
                                    ⭐⭐⭐⭐
                                </span>
                                {% elif task.priority_level == 3 %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-blue-500 text-white shadow-sm">
                                    ⭐⭐⭐
                                </span>
                                {% elif task.priority_level == 2 %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-500 text-white shadow-sm">
                                    ⭐⭐
                                </span>
                                {% elif task.priority_level == 1 %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-400 text-white shadow-sm">
                                    ⭐
                                </span>
                                {% endif %}
                                {% endif %}

                                <!-- Priority Score (NEW) -->
                                {% if task.priority_score %}
                                <div class="relative group/score inline-block">
                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold 
                                        {% if task.priority_score >= 8.0 %}bg-emerald-100 text-emerald-700
                                        {% elif task.priority_score >= 5.0 %}bg-blue-100 text-blue-700
                                        {% else %}bg-gray-100 text-gray-600{% endif %} whitespace-nowrap">
                                        <i data-lucide="bar-chart-2" class="w-3 h-3"></i>
                                        Score: {{ task.priority_score|floatformat:1 }}
                                    </span>

                                    <!-- Score Breakdown Tooltip -->
                                    <div
                                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-gray-900 text-white text-xs rounded-lg p-3 opacity-0 invisible group-hover/score:opacity-100 group-hover/score:visible transition-all z-20 shadow-xl pointer-events-none">
                                        <div class="font-bold mb-1 border-b border-gray-700 pb-1">Score Breakdown</div>
                                        <div class="space-y-1">
                                            <div class="flex justify-between"><span>Urgency:</span> <span
                                                    class="text-gray-300">{{ task.urgency_score|default:0|floatformat:1 }}</span>
                                            </div>
                                            <div class="flex justify-between"><span>Location:</span> <span
                                                    class="text-gray-300">{{ task.location_score|default:0|floatformat:1 }}</span>
                                            </div>
                                            <div class="flex justify-between"><span>Preference:</span> <span
                                                    class="text-gray-300">{{ task.preference_score|default:0|floatformat:1 }}</span></div>
                                            <div class="flex justify-between"><span>Time:</span> <span
                                                    class="text-gray-300">{{ task.time_window_score|default:0|floatformat:1 }}</span></div>
                                        </div>
                                        <div
                                            class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-gray-900 rotate-45">
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            {% if task.is_urgent %}
                            <span
                                class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-red-50 text-red-600 border border-red-100 animate-pulse whitespace-nowrap">
                                <i data-lucide="flame" class="w-3 h-3"></i> Urgent
                            </span>
                            {% else %}
                            <span class="text-xs text-gray-400 font-medium whitespace-nowrap ml-auto">
                                {{ task.created_at|timesince }} ago
                            </span>
                            {% endif %}
                        </div>

                        <!-- Title & Desc -->
                        <div class="flex-grow">
                            <h3
                                class="text-lg font-bold text-gray-900 mb-2 group-hover:text-indigo-600 transition-colors line-clamp-2">
                                <a href="{% url 'task_detail' task.id %}">{{ task.title }}</a>
                            </h3>
                            <p class="text-sm text-gray-500 line-clamp-3 mb-4 leading-relaxed">
                                {{ task.description }}
                            </p>
                        </div>

                        <!-- Divider -->
                        <div class="h-px bg-gray-100 w-full my-4"></div>

                        <!-- Footer Info -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    {% if task.poster.profile_picture %}
                                    <img src="{{ task.poster.profile_picture.url }}" alt="Poster"
                                        class="w-8 h-8 rounded-full object-cover border border-white shadow-sm">
                                    {% else %}
                                    <div
                                        class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center border border-white shadow-sm">
                                        <span class="text-xs font-bold text-gray-500">{{ task.poster.fullname|make_list|first }}</span>
                                    </div>
                                    {% endif %}
                                    <div
                                        class="absolute -bottom-1 -right-1 w-3 h-3 bg-emerald-500 border-2 border-white rounded-full">
                                    </div>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-gray-900">{{ task.poster.fullname|truncatechars:15 }}</span>
                                    <div class="flex items-center gap-0.5">
                                        <i data-lucide="star" class="w-3 h-3 text-amber-400 fill-current"></i>
                                        <span class="text-[10px] font-bold text-gray-500">{{ task.poster.avg_rating|default:"0.0" }}</span>


                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                <span class="block text-lg font-black text-indigo-600">₱{{ task.price }}</span>
                            </div>
                        </div>

                        <!-- Hover Action (Optional Overlay) -->
                        <a href="{% url 'task_detail' task.id %}"
                            class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-white via-white to-transparent translate-y-full group-hover:translate-y-0 transition-transform duration-300 flex justify-center">
                            <span
                                class="w-full bg-indigo-600 text-white py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 text-center">
                                View Details
                            </span>
                        </a>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if tasks.has_other_pages %}
                <!-- Simple Pagination Implementation (can use existing snippet or simple next/prev) -->
                <div class="flex justify-center mt-10">
                    <div class="bg-white rounded-xl shadow-lg shadow-gray-200/50 p-2 flex items-center gap-2">
                        {% if tasks.has_previous %}
                        <a href="?page={{ tasks.previous_page_number }}{% if filter_form.search.value %}&search={{ filter_form.search.value }}{% endif %}"
                            class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-50 text-gray-600 transition-colors">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </a>
                        {% endif %}

                        <span class="px-4 text-sm font-bold text-gray-900">Page {{ tasks.number }} of
                            {{ tasks.paginator.num_pages }}</span>

                        {% if tasks.has_next %}
                        <a href="?page={{ tasks.next_page_number }}{% if filter_form.search.value %}&search={{ filter_form.search.value }}{% endif %}"
                            class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-50 text-gray-600 transition-colors">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% else %}
                <!-- Empty State -->
                <div class="bg-white rounded-3xl p-12 text-center border border-dashed border-gray-200">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="search-x" class="w-10 h-10 text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">No tasks found</h3>
                    <p class="text-gray-500 max-w-md mx-auto mb-8">
                        We couldn't find any tasks matching your current filters. Try adjusting your search criteria or
                        come back later!
                    </p>
                    <a href="{% url 'browse_tasks' %}"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold hover:bg-indigo-100 transition-colors">
                        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                        Reset Filters
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Lucide Icons
    lucide.createIcons();
</script>
{% endblock %}